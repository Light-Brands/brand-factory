# Epic 06: Business - Business Profiles & Services

**Epic ID**: EPIC-06-BUSINESS  
**Priority**: P1 (Network expansion)  
**Timeline**: 3-4 weeks  
**Dependencies**: Epic 0, 1, 2, 4

**Reference Figma**: [Business Board](https://www.figma.com/design/sOWyiGHTjRezhqCUS7rWwv/VibeUp-Handoff----Hi-fi?node-id=1-75602&t=ZIRw7Rc3rtyFrQRK-0)

---

## Vision & Objectives

**Goal**: Deeply expand network-effect by onboarding purpose-driven businesses into the VIBEUP ecosystem.

**Summary**: Allow members to discover aligned offerings from purpose-driven businesses. Businesses can showcase identity, services, and member perks through comprehensive profiles with modular listings (Services, Products, Events, Courses, Properties, Jobs). Premium businesses unlock additional features (advanced Listings, Communities, visibility boosts).

**Mira serves as services guide and business advisor**, recommending aligned businesses, explaining perks, facilitating bookings, and framing commercial interactions through a values-first lens. Mira guides both business owners through profile creation and members through discovery—ensuring all commercial interactions feel authentic, values-aligned, and purposeful.

### Mira's Role as Services Guide & Business Advisor

**Business Discovery & Recommendations**:
- "Based on your interest in sound healing and stress relief intention, I found 3 verified practitioners within 5 miles."
- "Your practice data shows stress patterns. Would a massage or reiki session help reset your nervous system?"
- "This yoga studio offers 15 class types. Based on your profile, I'd recommend their Yin and Meditation classes."
- "3 of your connections have booked with this coach and rated them 5 stars—strong social proof for quality."

**Crypto Payments & Tips (Epic 1A Integration)**:
- "This studio accepts USDC payments—check out instantly without credit card fees."
- "Had a great session? Send a tip directly to your instructor using VIBES tokens."
- "Your payment of $75 USDC went through instantly. No waiting for banks!"
- "This business offers a 5% discount for crypto payments. Your total: $47.50 USDC instead of $50."
- "Redeem your VIBES perks here! As a staker, you get 15% off all services."

**Service Education & Value**:
- "This business offers Sound Healing Ceremonies. Let me explain: Sound healing uses vibrational frequencies to promote relaxation and energetic alignment. Perfect for your interest in Energy Work."
- "Life Coaching vs. Therapy: Coaching focuses on goals and future growth (matches your Growth value), while therapy addresses past healing. Want both options?"

**Perk Discovery & Framing**:
- "As a Regenerative member, you get 20% off this service. That's $30 savings—more than your monthly membership cost!"
- "This perk unlocks a free intro session. Perfect for exploring without commitment."
- "Member perk available: First month free at this yoga studio. Your wellness investment pays for itself."

**Booking Assistance**:
- "Ready to book? I can help you find a time that works with your schedule."
- "You usually practice mornings. This business has 9 AM availability Tuesday and Thursday."
- "You booked a session for Wednesday! Want me to add a practice reminder for that morning?"

**Alignment & Compatibility**:
- "This business shares your values: Sustainability, Authenticity, Community. They donate 1% of revenue to environmental causes."
- "The business owner is also a VIBEUP member with 85% alignment to you. You might genuinely connect!"
- "This studio is 0.8 miles from you and has 12 members from your community. Build local wellness connections."

**Social Proof & Trust Building**:
- "Sarah and Alex both recommend this business. Trust from your network matters."
- "Verified Business Badge means we've confirmed their credentials, insurance, and values alignment."
- "This business has 47 5-star reviews from VIBEUP members. Quality validated by your community."

**Post-Experience**:
- "How was your session with [Business]? Your review helps others discover aligned services."
- "You've visited this studio 3 times this month. Want to bookmark it as a favorite?"
- "Your session notes mention feeling 'calm and centered.' That's the power of aligned wellness services!"

**Business Onboarding (For Business Owners)**:
- "Welcome! Let's create your business profile. This helps aligned members discover your offerings."
- "Your profile is 70% complete. Adding services and perks helps members understand what you offer."
- "Verification unlocks trust. Upload credentials and we'll review within 48 hours."
- "Your first member booking! This is the beginning of serving your community through VIBEUP."

**Values-First Commerce Philosophy**:
- Mira never says "buy now" or uses urgency tactics
- Always frames services as alignment and growth opportunities
- Emphasizes community benefit, not transaction
- Respects user autonomy: "When you're ready..." not "Limited time!"

---

**Brand Identity**: This epic's implementation follows [brand identity guidelines](../brand/):
- **Visual**: Business cards follow [visual identity standards](../brand/01-visual-identity.md) - 16px border radius, clear hierarchy, spacious layouts
- **Copy**: All messaging uses [brand voice guidelines](../brand/03-brand-voice-messaging.md) - conscious commerce, values-first framing
- **Mira**: AI interactions embody [Mira's personality](../brand/04-mira-personality-guide.md) as business advisor
- **Integration**: See [brand-identity-integration.md](brand-identity-integration.md#epic-06-business-profiles) for Epic 06 specific requirements

**Key Brand Touchpoints**:
- Business descriptions frame services as support for journey ("What they offer to support your journey" not "Features offered")
- Verification badges use trust language ("Verified by VIBEUP community" not "Verified Business")
- Service recommendations supportive, not promotional
- Reviews emphasize authenticity and experience over ratings
- Perk messaging frames value clearly without aggressive sales tactics

---

### Success Metrics

**Primary**:
- **Profile Creation Funnel**: 30%+ of invited businesses complete profile creation (Mira's welcoming)
- **Profile Completion Rate**: 60%+ of businesses complete 60%+ of attributes (Mira's guidance)
- **Engagement**: Average views, follows, and connections per business profile tracked
- **Business Verification**: 80%+ verified within 7 days (Mira's education + streamlined process)

**Secondary/Future**:
- **Listings Activity**: % of businesses with ≥1 active service/product/event listing
- **Member Perk Usage**: % of Premium members who redeem business perks
- **Discovery Impact**: Click-through rate from Discovery search to business profiles
- **Community Growth**: # of communities launched by businesses

**Mira-Specific KPIs**:
- 70%+ users rate Mira's business recommendations as "relevant" or "very relevant"

**Crypto KPIs (Epic 1A Integration)**:
- 30%+ businesses enable crypto payments (USDC)
- 15%+ bookings paid via crypto

**KARMA for Conscious Commerce (Epic 1B Integration)**:
Commerce activities earn KARMA, rewarding conscious economic choices:

**Booking & Review KARMA**:
- Book conscious business: +15 KARMA
- Leave thoughtful review (>100 characters): +20 KARMA
- Tip service provider: +10 KARMA + 5% of tip amount
- Support local/verified business (first booking): +25 KARMA
- Redeem VIBES for perk: +10 KARMA (circular economy)

**Business Recognition**:
- High-KARMA businesses get "Karma-Verified" badge
- Business KARMA calculated from customer engagement
- Businesses can see which clients have high KARMA (trust indicator)

**Eco-Friendly Choices**:
- Book eco-certified business: +20 KARMA bonus
- Choose sustainable options: +10 KARMA
- Support B-Corp or mission-aligned business: +15 KARMA

**Mira Commerce KARMA**:
- "Booking with Sound Haven earns +15 KARMA—they're verified conscious business!"
- "Great tip! +10 KARMA plus 5% of your $20 tip = +11 KARMA total."
- "You've supported 12 local businesses. Your 318 Commerce KARMA shows your commitment to conscious commerce."
- "This studio has a 'Karma-Verified' badge from 500+ positive customer interactions."
- 50%+ of tips processed through VIBES tokens
- 20%+ businesses receive direct tips from customers
- 35%+ conversion on Mira-recommended business profiles vs 15% organic
- Business owners rate Mira's onboarding as "helpful" 85%+ of time
- 50%+ of users engage with business content through Mira prompts

---

## User Journey

### Entry Points

Users can create a business profile from multiple entry points:
1. **During Onboarding**: If user selects "Grow My Business" or "Networking" as intention
2. **From Account Settings**: "Add Your Business" option
3. **From Human Profile**: "Create Your Business Listing" CTA
4. **From CTA Buttons**: When browsing Discovery marketplace

### Creation Flow

**Guided Setup (Primary Path - Mira-Led)**:
- Mira guides business owners through conversational prompts
- Progressive disclosure reveals sections as previous ones complete
- Explanations provided for each attribute's purpose
- Preview of profile shown throughout process
- Encouragement and completion status displayed

**Direct Edit Mode (Secondary Path)**:
- Quick setup for experienced users
- Form-based interface with all fields visible
- Validation and required field indicators
- Can switch to Guided mode at any time

### Profile Organization

**Business Profile Structure** (following three-part framework):

**Header Section**:
- Business name, logo/profile image, handle (@businessname)
- Short description (140 chars)
- Location (city, country, or "Online")
- Verification badge (if verified)
- Connection count, # posts (if community active)
- Primary CTA (Contact, Book, Join Community)

**Body Section - Organized by Framework**:

**1. What Guides Us** (Purpose & Identity):
- About section (full description, story, what makes business unique)
- Business Purpose (Wellness, Coaching, Community, Lifestyle, Healing, Product-Based, etc.)
- Image gallery (up to 6 showcase images)
- Business Managed By (linked Human profile - hidden by default)
- # of Employees (1, 2-10, 11-50, 51-200, 200+)
- Size Category (Solo, SMB, Mid-Market, Large Enterprise)
- Markets Served (Local, Regional, National, Global, Online)

**2. What We Offer** (Services & Value):
- **Listings** (modular tabs - see Listings System below)
- Service Type Tags (Yoga, Therapy, Coaching, Retreats, Nutrition, etc.)
- Recommended Practices (linked to Practice Database)
- Member Perks (Discount, Free Trial, Free Event, Exclusive Content, Gift)
- Connection Preferences (Messenger, Phone, Video, Appointment Booking, In-Person)

**3. How We Flow** (Engagement & Energy):
- Connection Prompts (pre-filled Q&A to spark conversations)
  - Example: "What inspires you most in your work?"
  - Example: "How can people support your mission?"
- Archetype/Vibe (auto-generated by Mira after profile completion - future phase)
- Contact Info (Email, Phone, Website - visibility controlled)
- Social Links (Instagram, Facebook, LinkedIn, YouTube, TikTok)

**Listings System** (Modular Tabs):
- Business Profile page is the first tab (like Human Profile: About | Chemistry | Photos | Vibes)
- Additional tabs appear as listings are created:
  - **Services**: Service offerings with templates
  - **Products**: Physical/digital products for sale
  - **Events**: Workshops, retreats, gatherings
  - **Courses**: Educational offerings
  - **Properties**: Spaces, venues, rentals
  - **Jobs**: Employment opportunities
- Each category has:
  - Search functionality
  - Sort options (price, date, relevance)
  - Filter capability
  - Simple template per listing type
  - Click opens detailed view (booking/purchasing features in future phases)

---

## Business Profile Attribute Organization Framework

At the heart of VIBEUP is the belief that **connection happens when we understand not just what someone does, but what moves them, where they're curious, and how they bring their energy into the world.** 

Mira organizes business profile attributes into **three complementary groups** (mirroring Human Profiles):

### 1. What Guides Us
**The values, purpose, or motivations shaping the business**

*How we use it*: Anchors archetype creation and helps the platform suggest connections or practices aligned to someone's deeper "why."

Attributes:
- Business Purpose Statement
- About Section (story and uniqueness)
- Core Values (if applicable)
- Mission/Vision
- Image Gallery (visual storytelling)

### 2. What We Offer
**The services, practices, listings, and communities offered**

*How we use it*: Provides common ground for social discovery, making it easier to surface relevant resources, content, or communities.

Attributes:
- Listings (Services, Products, Events, Courses, Properties, Jobs)
- Service Type Tags
- Recommended Practices
- Member Perks
- Connection Preferences

### 3. How We Flow
**The way the business expresses and carries their energy**

*How we use it*: Adds nuance to matching, ensuring discovery isn't just about shared interests but about resonance in style and preference.

Attributes:
- Connection Prompts
- Connection Preferences (communication style)
- Self-descriptions and vibe cues
- Social presence and engagement style
- Archetype/Vibe (Mira-generated)

Together, these three groups form a **living snapshot of identity and intention**—easy for business owners to complete in a guided, gamified flow, yet structured enough for VIBEUP to deliver meaningful recommendations that feel personal and intentional.

---

## Complete Business Profile Attributes

| **Attribute** | **Capture Method** | **Suggested Values / Options** | **Mira Prompt** | **How It's Used** |
|---------------|-------------------|-------------------------------|----------------|------------------|
| **Business Name** | Text input | Freeform | "What's the name of your business?" | Identifier across Discovery, search, and profile |
| **Handle** | Text input (validated unique) | @businessname | "Choose a handle for your business (like @VibeUPWellness)" | Unique profile URL and tagging in posts/discovery |
| **Logo / Profile Image** | Image upload | JPEG, PNG, SVG | "Upload your business logo or a main image" | Primary identifier in listings, search, and Discovery feeds |
| **Short Description** | Text input (140 chars max) | Freeform | "Write a short description to introduce your business" | Appears in search results and Discovery cards |
| **Contact Info** | Structured entry | Email, Phone, Website | "What's the best way for members to contact you?" | Provides legitimacy + trust |
| **Social Links** | URL input | Instagram, Facebook, LinkedIn, YouTube, TikTok, Website | "Add links where members can follow your work" | Extends reach beyond platform |
| **Location** | Map / Text entry | City, Country, Online-only | "Where is your business based, or are you fully online?" | Enables local search and geo-discovery |
| **Markets Served** | Multi-select | Local, Regional, National, Global, Online | "Who do you primarily serve?" | Helps members filter by reach |
| **Size Category** | Dropdown | Solo, SMB, Mid-Market, Large Enterprise | "What best describes your business size?" | Used for segmentation in analytics and discovery |
| **Verification Status** | System-admin flag | Unverified, Verified | Optional: "Would you like to verify your business?" | Builds trust, reduces spam |
| **Business Managed By** | Auto-linked to Human profile | Human profile (mandatory for admin) - **Hidden by default** | Not asked—auto linked | Ensures accountability, like Facebook Page Admins |
| | | | | |
| **WHAT GUIDES US** | | | | |
| **About Section** | Text area (multi-line) | Freeform | "Tell members about your story and what makes your work unique" | Deepens resonance and brand identity |
| **Business Purpose** | Dropdown + text | Wellness, Coaching, Community, Lifestyle, Healing, Product-Based, etc. | "What's the main purpose of your business?" | Improves recommendations and alignment cards |
| **Image Gallery** | Upload (up to 6) | JPEG, PNG | "Showcase your space, products, or community with up to 6 images" | Visual storytelling, increases engagement |
| **# of Employees** | Dropdown | 1, 2–10, 11–50, 51–200, 200+ | "How many people are part of your team?" | Signals scale and builds trust |
| | | | | |
| **WHAT WE OFFER** | | | | |
| **Listings** | Structured templates | Services, Products, Events, Courses, Jobs, Properties | "Would you like to add any offerings right now?" | Marketplace integration |
| **Service Type Tags** | Multi-select chips | Predefined taxonomy (Yoga, Therapy, Coaching, Retreats, Nutrition, etc.) | "Select the types of services you offer" | Fuels Discovery search + filtering |
| **Connection Preferences** | Multi-select | Messenger, Phone, Video, Appointment Booking, In-Person | "How do you prefer people connect with you?" | Guides connection UX across the app |
| **Member Perks** | Structured entry | Discount, Free Trial, Free Event, Exclusive Content, Gift | "Would you like to offer perks for members?" | Drives Premium membership value |
| **Recommended Practices** | Multi-select chips | Pulled from Practice DB (Meditation, Journaling, Energy Work, etc.) | "Which practices best represent your offerings?" | Feeds Discovery + Practice recommendations |
| | | | | |
| **HOW WE FLOW** | | | | |
| **Connection Prompts** | Pre-filled Q&A prompts | Example: "What inspires you most in your work?", "How can people support your mission?" | "Choose a prompt to spark meaningful conversations" | Increases engagement, reduces cold-start problem |
| **Community (Optional)** | Linked module | Community Name, Welcome Message, Rules | "Do you want to create a community linked to your business?" | Extends business into community-led engagement |
| **Archetype / Vibe** | Auto-generated by Mira (later phase) | Wellness Archetype Framework (Healer, Teacher, Connector, Creator, etc.) | Not user-input; suggested after profile completion | Enhanced matching and discovery |

---

## Business Verification System

### Purpose
- Build trust and authenticity in the VIBEUP ecosystem
- Reduce impersonation and spam
- Provide members with confidence when engaging businesses

### Verification Levels

**Unverified** (default):
- Any new business profile
- Can still create listings and engage
- No verification badge displayed

**Verified**:
- Businesses that pass authenticity check
- Verification badge shown on profile, listings, and Discovery results
- Higher visibility in search and recommendations

### Verification Methods (MVP)

1. **Domain Email Check** (fastest path):
   - Confirm ownership via official business email (@company.com)
   - Automated verification process
   - Instant verification upon confirmation

2. **EIN or Document Upload**:
   - Business provides Employer Identification Number (U.S.) or equivalent
   - Uploads business license/registration document if EIN not applicable
   - Admin review required (24-48 hours)

3. **Human Profile Link**:
   - Every business must be tied to a verified Human profile admin
   - Ensures accountability and reduces fraud

### Verification Process

1. **Prompt**: During profile setup or later from settings
2. **Submission**: Business owner chooses method and submits:
   - Domain email verification link, **or**
   - EIN number (validated for correct format), **or**
   - Uploads official business document (PDF, JPEG, PNG)
3. **Validation**:
   - Domain/EIN: Automatic validation by system
   - Documents: Routed to admin review queue
4. **Badge Applied**: Verified badge appears on profile + listings + Discovery results
5. **Badge Display**:
   - Shown next to business name in all contexts
   - Tooltip: "Verified by VIBEUP — authenticity confirmed"

### Re-Verification

- **Annual Requirement**: Verification expires after 12 months
- **Change Triggers**: Required if business name or ownership changes
- **Notification**: Admin notified 30 days before expiry
- **Grace Period**: 14 days post-expiry before badge removed

### Admin & Permission Controls

**Multiple Admin Support**:
- At least one verified Human profile must remain linked
- Support for multiple admins with role-based permissions:
  - **Owner**: Full control (edit profile, manage admins, delete business)
  - **Editor**: Edit profile, manage listings, respond to messages
  - **Community Manager**: Manage community posts, moderate, engage members

**Security Requirements**:
- MFA required for all admin accounts
- Audit log of all admin actions
- Admin changes require notification to Owner

### Privacy & Data Security Guardrails

**Permission Controls**:
- Businesses can assign multiple admins with role-based permissions
- Admin activity logged for accountability

**Data Privacy**:
- Contact info & location set to "public" or "private" (user-controlled)
- No sharing of personal Human profile data unless explicitly chosen
- Clear opt-out & deletion pathways

**Owner Identity Link**:
- Each business profile always tied to verified Human profile (like Facebook Page admins)
- Hidden by default but accessible to VIBEUP admins for accountability

**Security Measures**:
- All profiles protected with MFA
- Data encrypted in transit and at rest
- Session timeout after 30 minutes of inactivity
- Suspicious activity monitoring

---

## Database Schema

```sql
-- Business Profiles
CREATE TABLE businesses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  owner_id UUID NOT NULL REFERENCES profiles(id), -- Linked human profile (mandatory admin)
  
  -- Basic info
  business_name TEXT NOT NULL,
  handle TEXT UNIQUE NOT NULL, -- @businessname
  short_description TEXT CHECK (char_length(short_description) <= 140), -- 140 chars max
  about TEXT, -- Full description (story and uniqueness)
  
  -- What Guides Us
  business_purpose TEXT, -- 'wellness', 'coaching', 'community', 'lifestyle', 'healing', 'product_based', etc.
  image_gallery TEXT[], -- Up to 6 showcase images
  employee_count_range TEXT, -- '1', '2-10', '11-50', '51-200', '200+'
  business_size TEXT, -- 'solo', 'smb', 'mid_market', 'large_enterprise'
  
  -- Contact & Social
  email TEXT,
  phone TEXT,
  website TEXT,
  social_links JSONB, -- { instagram, facebook, linkedin, youtube, tiktok, website }
  contact_visibility TEXT DEFAULT 'public', -- 'public', 'private', 'members_only'
  
  -- Location
  location JSONB, -- { city, country, coordinates } or "online"
  markets_served TEXT[], -- 'local', 'regional', 'national', 'global', 'online'
  
  -- What We Offer
  service_tags TEXT[], -- Yoga, Therapy, Coaching, Retreats, Nutrition, etc.
  recommended_practices TEXT[], -- Practice names from practice_definitions
  connection_preferences TEXT[], -- 'messenger', 'phone', 'video', 'appointment', 'in_person'
  
  -- How We Flow
  connection_prompts JSONB, -- [{ question: "What inspires you?", answer: "..." }, ...]
  archetype TEXT, -- Auto-generated by Mira (future phase): 'healer', 'teacher', 'connector', 'creator'
  
  -- Media
  logo_url TEXT,
  
  -- Verification
  verification_status TEXT DEFAULT 'unverified', -- 'unverified', 'verified'
  verified_at TIMESTAMPTZ,
  verification_expires_at TIMESTAMPTZ, -- Annual re-verification
  
  -- State
  is_active BOOLEAN DEFAULT true,
  profile_completion_percent INTEGER DEFAULT 0, -- Calculated on update
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- URL structure: vibeup.io/weare/[handle]
  CONSTRAINT handle_format CHECK (handle ~ '^[a-z0-9_]{3,30}$'),
  CONSTRAINT short_description_length CHECK (char_length(short_description) <= 140),
  CONSTRAINT image_gallery_limit CHECK (array_length(image_gallery, 1) <= 6)
);

-- Business Admins (Multiple admin support with roles)
CREATE TABLE business_admins (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_id UUID NOT NULL REFERENCES businesses(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  
  role TEXT NOT NULL, -- 'owner', 'editor', 'community_manager'
  
  granted_by UUID REFERENCES profiles(id), -- Who added this admin
  granted_at TIMESTAMPTZ DEFAULT NOW(),
  
  is_active BOOLEAN DEFAULT true,
  
  UNIQUE(business_id, user_id),
  CONSTRAINT valid_role CHECK (role IN ('owner', 'editor', 'community_manager'))
);

-- Business Services/Listings (Modular Tabs)
CREATE TABLE business_listings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_id UUID NOT NULL REFERENCES businesses(id) ON DELETE CASCADE,
  
  listing_type TEXT NOT NULL, -- 'service', 'product', 'event', 'course', 'property', 'job'
  title TEXT NOT NULL,
  description TEXT,
  price DECIMAL(10,2),
  currency TEXT DEFAULT 'USD',
  image_url TEXT,
  image_gallery TEXT[], -- Additional images per listing
  
  -- Metadata per type (type-specific fields)
  metadata JSONB, 
  -- Examples:
  -- Service: { duration: "60 min", delivery: "in-person" }
  -- Event: { date: "2025-12-20", location: "San Francisco" }
  -- Course: { duration: "6 weeks", format: "online" }
  -- Job: { job_type: "full-time", location: "remote" }
  
  -- Search & Discovery
  searchable BOOLEAN DEFAULT true,
  tags TEXT[], -- Additional search tags
  
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  CONSTRAINT valid_listing_type CHECK (listing_type IN ('service', 'product', 'event', 'course', 'property', 'job'))
);

-- Business Perks (Member benefits)
CREATE TABLE business_perks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_id UUID NOT NULL REFERENCES businesses(id) ON DELETE CASCADE,
  
  perk_title TEXT NOT NULL,
  perk_description TEXT,
  perk_type TEXT, -- 'discount', 'free_trial', 'free_event', 'exclusive_content', 'gift'
  perk_value TEXT, -- "20% off", "First week free", etc.
  
  -- Featured Perk (NEW from Refresh)
  is_featured BOOLEAN DEFAULT false, -- Only 1 can be featured per business
  featured_short_text TEXT CHECK (char_length(featured_short_text) <= 50), -- "First Week Free" - shows in header
  
  -- Redemption
  promo_code TEXT,
  redemption_link TEXT,
  max_redemptions INTEGER, -- NULL = unlimited
  current_redemptions INTEGER DEFAULT 0,
  
  -- Restrictions
  premium_only BOOLEAN DEFAULT true, -- Only for regenerative members
  expires_at TIMESTAMPTZ,
  
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- Constraint: Only one featured perk per business
  CONSTRAINT one_featured_perk_per_business UNIQUE NULLS NOT DISTINCT (business_id, is_featured)
);

-- Business Reviews (NEW from Refresh)
CREATE TABLE business_reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_id UUID NOT NULL REFERENCES businesses(id) ON DELETE CASCADE,
  reviewer_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  review_text TEXT,
  
  -- Moderation
  is_hidden BOOLEAN DEFAULT false, -- Business can hide up to 3 reviews
  hidden_at TIMESTAMPTZ,
  hidden_by UUID REFERENCES profiles(id),
  
  -- Meta
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- Constraint: One review per user per business
  UNIQUE(business_id, reviewer_id)
);

-- Track hidden review count per business
CREATE OR REPLACE FUNCTION check_hidden_reviews_limit()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.is_hidden = true THEN
    DECLARE
      hidden_count INTEGER;
    BEGIN
      SELECT COUNT(*) INTO hidden_count
      FROM business_reviews
      WHERE business_id = NEW.business_id
      AND is_hidden = true
      AND id != NEW.id;
      
      IF hidden_count >= 3 THEN
        RAISE EXCEPTION 'Cannot hide more than 3 reviews per business';
      END IF;
    END;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER enforce_hidden_reviews_limit
  BEFORE UPDATE ON business_reviews
  FOR EACH ROW
  EXECUTE FUNCTION check_hidden_reviews_limit();

-- Practice Stacks (Business-Recommended Practices)
CREATE TABLE practice_stacks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_id UUID NOT NULL REFERENCES businesses(id) ON DELETE CASCADE,
  
  stack_name TEXT NOT NULL,
  description TEXT,
  practices TEXT[], -- Array of practice names
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Business Verification Documents
CREATE TABLE business_verification (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_id UUID UNIQUE NOT NULL REFERENCES businesses(id) ON DELETE CASCADE,
  
  verification_method TEXT, -- 'domain_email', 'ein', 'document_upload'
  
  -- Supporting data
  domain_email TEXT,
  domain_email_verified BOOLEAN DEFAULT false,
  domain_email_token TEXT, -- Verification token
  ein_number TEXT,
  document_urls TEXT[],
  
  -- Review
  status TEXT DEFAULT 'pending', -- 'pending', 'approved', 'rejected'
  reviewed_by UUID REFERENCES profiles(id),
  reviewed_at TIMESTAMPTZ,
  rejection_reason TEXT,
  
  -- Re-verification tracking
  verification_count INTEGER DEFAULT 1,
  last_verified_at TIMESTAMPTZ,
  
  submitted_at TIMESTAMPTZ DEFAULT NOW(),
  
  CONSTRAINT valid_verification_method CHECK (verification_method IN ('domain_email', 'ein', 'document_upload')),
  CONSTRAINT valid_status CHECK (status IN ('pending', 'approved', 'rejected'))
);

-- Business Admin Activity Log (Audit trail)
CREATE TABLE business_admin_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_id UUID NOT NULL REFERENCES businesses(id) ON DELETE CASCADE,
  admin_id UUID NOT NULL REFERENCES profiles(id),
  
  action TEXT NOT NULL, -- 'profile_edit', 'listing_create', 'admin_add', 'admin_remove', etc.
  changes JSONB, -- What changed
  ip_address TEXT,
  user_agent TEXT,
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for performance
CREATE INDEX idx_businesses_handle ON businesses(handle);
CREATE INDEX idx_businesses_owner ON businesses(owner_id);
CREATE INDEX idx_businesses_location ON businesses USING GIN(location);
CREATE INDEX idx_businesses_service_tags ON businesses USING GIN(service_tags);
CREATE INDEX idx_businesses_verification ON businesses(verification_status);
CREATE INDEX idx_business_listings_type ON business_listings(listing_type);
CREATE INDEX idx_business_listings_business ON business_listings(business_id);
CREATE INDEX idx_business_admins_user ON business_admins(user_id);
CREATE INDEX idx_business_perks_featured ON business_perks(business_id, is_featured) WHERE is_featured = true;
CREATE INDEX idx_business_reviews_business ON business_reviews(business_id);
CREATE INDEX idx_business_reviews_reviewer ON business_reviews(reviewer_id);

-- Enable Row Level Security
ALTER TABLE businesses ENABLE ROW LEVEL SECURITY;
ALTER TABLE business_listings ENABLE ROW LEVEL SECURITY;
ALTER TABLE business_perks ENABLE ROW LEVEL SECURITY;
ALTER TABLE business_admins ENABLE ROW LEVEL SECURITY;
ALTER TABLE business_verification ENABLE ROW LEVEL SECURITY;
ALTER TABLE business_admin_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE practice_stacks ENABLE ROW LEVEL SECURITY;
ALTER TABLE business_reviews ENABLE ROW LEVEL SECURITY;

-- RLS Policies

-- Public can view active businesses
CREATE POLICY businesses_select_active ON businesses
  FOR SELECT USING (is_active = true);

-- Owners and admins can manage their businesses
CREATE POLICY businesses_manage_own ON businesses
  FOR ALL USING (
    auth.uid() = owner_id OR
    auth.uid() IN (
      SELECT user_id FROM business_admins 
      WHERE business_id = businesses.id 
      AND is_active = true 
      AND role IN ('owner', 'editor')
    )
  );

-- Public can view active listings
CREATE POLICY listings_select_active ON business_listings
  FOR SELECT USING (
    is_active = true AND
    EXISTS (SELECT 1 FROM businesses WHERE id = business_listings.business_id AND is_active = true)
  );

-- Admins can manage listings
CREATE POLICY listings_manage_by_admin ON business_listings
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM business_admins 
      WHERE business_id = business_listings.business_id 
      AND user_id = auth.uid() 
      AND is_active = true
      AND role IN ('owner', 'editor')
    )
  );

-- Public can view active perks
CREATE POLICY perks_select_active ON business_perks
  FOR SELECT USING (
    is_active = true AND
    (expires_at IS NULL OR expires_at > NOW())
  );

-- Admins can manage perks
CREATE POLICY perks_manage_by_admin ON business_perks
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM business_admins 
      WHERE business_id = business_perks.business_id 
      AND user_id = auth.uid() 
      AND is_active = true
      AND role IN ('owner', 'editor')
    )
  );

-- Owners can manage business admins
CREATE POLICY admins_manage_by_owner ON business_admins
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM business_admins owner_check
      WHERE owner_check.business_id = business_admins.business_id 
      AND owner_check.user_id = auth.uid() 
      AND owner_check.role = 'owner'
      AND owner_check.is_active = true
    )
  );

-- Users can view their own admin status
CREATE POLICY admins_view_own ON business_admins
  FOR SELECT USING (user_id = auth.uid());

-- Admins can view verification status
CREATE POLICY verification_view_by_admin ON business_verification
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM business_admins 
      WHERE business_id = business_verification.business_id 
      AND user_id = auth.uid() 
      AND is_active = true
    )
  );

-- Admins can submit/update verification
CREATE POLICY verification_manage_by_admin ON business_verification
  FOR INSERT, UPDATE USING (
    EXISTS (
      SELECT 1 FROM business_admins 
      WHERE business_id = business_verification.business_id 
      AND user_id = auth.uid() 
      AND is_active = true
      AND role IN ('owner', 'editor')
    )
  );

-- Platform admins can view all logs
CREATE POLICY admin_logs_admin_view ON business_admin_logs
  FOR SELECT USING (
    EXISTS (SELECT 1 FROM admin_users WHERE user_id = auth.uid())
  );

-- Business admins can view their business logs
CREATE POLICY admin_logs_business_view ON business_admin_logs
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM business_admins 
      WHERE business_id = business_admin_logs.business_id 
      AND user_id = auth.uid() 
      AND is_active = true
    )
  );

-- Public can view non-hidden reviews
CREATE POLICY reviews_public_view ON business_reviews
  FOR SELECT USING (
    is_hidden = false AND
    EXISTS (SELECT 1 FROM businesses WHERE id = business_reviews.business_id AND is_active = true)
  );

-- Users can create reviews for businesses
CREATE POLICY reviews_create ON business_reviews
  FOR INSERT WITH CHECK (auth.uid() = reviewer_id);

-- Reviewers can update their own reviews
CREATE POLICY reviews_update_own ON business_reviews
  FOR UPDATE USING (auth.uid() = reviewer_id);

-- Business admins can hide reviews (up to 3 per business)
CREATE POLICY reviews_hide_by_admin ON business_reviews
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM business_admins 
      WHERE business_id = business_reviews.business_id 
      AND user_id = auth.uid() 
      AND is_active = true
      AND role IN ('owner', 'editor')
    )
  );
```

---

## Service Layer

```typescript
/**
 * BUSINESS SERVICE
 * ================
 */
export class BusinessService extends BaseDatabaseService {
  
  /**
   * Create a new business profile linked to a human profile
   */
  async createBusiness(ownerId: string, businessData: CreateBusinessInput): Promise<Business> {
    // Validate handle uniqueness
    const existingHandle = await this.supabase
      .from('businesses')
      .select('id')
      .eq('handle', businessData.handle)
      .maybeSingle();
    
    if (existingHandle.data) {
      throw new Error('Handle already taken');
    }
    
    // Create business linked to human profile
    const { data, error } = await this.supabase
      .from('businesses')
      .insert({
        owner_id: ownerId,
        business_name: businessData.name,
        handle: businessData.handle,
        short_description: businessData.shortDescription,
        about: businessData.about,
        business_purpose: businessData.purpose,
        location: businessData.location,
        markets_served: businessData.marketsServed,
        business_size: businessData.size,
        employee_count_range: businessData.employeeCount,
        service_tags: businessData.serviceTags,
        recommended_practices: businessData.recommendedPractices,
        connection_preferences: businessData.connectionPreferences,
        connection_prompts: businessData.connectionPrompts,
        email: businessData.email,
        phone: businessData.phone,
        website: businessData.website,
        social_links: businessData.socialLinks,
        logo_url: businessData.logoUrl,
        image_gallery: businessData.imageGallery
      })
      .select()
      .single();
    
    if (error) throw error;
    
    // Automatically create owner as admin
    await this.addBusinessAdmin(data!.id, ownerId, 'owner', ownerId);
    
    // Log creation
    await this.logAdminAction(data!.id, ownerId, 'business_created', { businessId: data!.id });
    
    // Calculate initial profile completion
    await this.updateProfileCompletion(data!.id);
    
    return data!;
  }
  
  /**
   * Update business profile and recalculate completion
   */
  async updateBusiness(
    businessId: string, 
    userId: string, 
    updates: Partial<BusinessUpdateInput>
  ): Promise<Business> {
    // Verify user is admin
    await this.verifyBusinessAdmin(businessId, userId);
    
    const { data, error } = await this.supabase
      .from('businesses')
      .update({
        ...updates,
        updated_at: new Date().toISOString()
      })
      .eq('id', businessId)
      .select()
      .single();
    
    if (error) throw error;
    
    // Log update
    await this.logAdminAction(businessId, userId, 'profile_updated', updates);
    
    // Recalculate completion
    await this.updateProfileCompletion(businessId);
    
    return data!;
  }
  
  /**
   * Calculate profile completion percentage
   */
  async updateProfileCompletion(businessId: string): Promise<number> {
    const { data } = await this.supabase
      .from('businesses')
      .select('*')
      .eq('id', businessId)
      .single();
    
    if (!data) throw new Error('Business not found');
    
    const requiredFields = [
      'business_name', 'handle', 'short_description', 'about', 
      'business_purpose', 'location', 'email', 'logo_url'
    ];
    
    const optionalFields = [
      'phone', 'website', 'social_links', 'image_gallery',
      'service_tags', 'recommended_practices', 'connection_preferences',
      'connection_prompts', 'markets_served', 'employee_count_range'
    ];
    
    let completed = 0;
    let total = requiredFields.length + optionalFields.length;
    
    // Count required fields (worth 2 points each)
    requiredFields.forEach(field => {
      if (data[field] && data[field] !== '') {
        completed += 2;
        total += 1; // Total counts 2 for required
      }
    });
    
    // Count optional fields (worth 1 point each)
    optionalFields.forEach(field => {
      if (data[field] && 
          (typeof data[field] === 'string' ? data[field] !== '' : 
           Array.isArray(data[field]) ? data[field].length > 0 : 
           data[field] !== null)) {
        completed += 1;
      }
    });
    
    const percentage = Math.round((completed / total) * 100);
    
    // Update profile completion
    await this.supabase
      .from('businesses')
      .update({ profile_completion_percent: percentage })
      .eq('id', businessId);
    
    return percentage;
  }
  
  /**
   * Add admin to business
   */
  async addBusinessAdmin(
    businessId: string,
    userId: string,
    role: 'owner' | 'editor' | 'community_manager',
    grantedBy: string
  ): Promise<void> {
    // Verify grantor is owner
    if (role === 'owner') {
      // Allow first owner creation
      const ownerExists = await this.supabase
        .from('business_admins')
        .select('id')
        .eq('business_id', businessId)
        .eq('role', 'owner')
        .maybeSingle();
      
      if (ownerExists.data) {
        throw new Error('Business already has an owner');
      }
    } else {
      await this.verifyBusinessAdmin(businessId, grantedBy, ['owner']);
    }
    
    const { error } = await this.supabase
      .from('business_admins')
      .insert({
        business_id: businessId,
        user_id: userId,
        role: role,
        granted_by: grantedBy
      });
    
    if (error) throw error;
    
    // Log action
    await this.logAdminAction(businessId, grantedBy, 'admin_added', { 
      newAdminId: userId, 
      role 
    });
  }
  
  /**
   * Remove admin from business
   */
  async removeBusinessAdmin(
    businessId: string,
    adminIdToRemove: string,
    removedBy: string
  ): Promise<void> {
    // Verify remover is owner
    await this.verifyBusinessAdmin(businessId, removedBy, ['owner']);
    
    // Cannot remove the last owner
    const ownerCount = await this.supabase
      .from('business_admins')
      .select('id', { count: 'exact' })
      .eq('business_id', businessId)
      .eq('role', 'owner')
      .eq('is_active', true);
    
    const adminToRemove = await this.supabase
      .from('business_admins')
      .select('role')
      .eq('business_id', businessId)
      .eq('user_id', adminIdToRemove)
      .single();
    
    if (adminToRemove.data?.role === 'owner' && (ownerCount.count || 0) <= 1) {
      throw new Error('Cannot remove the last owner');
    }
    
    // Soft delete
    await this.supabase
      .from('business_admins')
      .update({ is_active: false })
      .eq('business_id', businessId)
      .eq('user_id', adminIdToRemove);
    
    // Log action
    await this.logAdminAction(businessId, removedBy, 'admin_removed', { 
      removedAdminId: adminIdToRemove 
    });
  }
  
  /**
   * Verify user is admin of business
   */
  private async verifyBusinessAdmin(
    businessId: string, 
    userId: string,
    allowedRoles: ('owner' | 'editor' | 'community_manager')[] = ['owner', 'editor']
  ): Promise<void> {
    const { data } = await this.supabase
      .from('business_admins')
      .select('role')
      .eq('business_id', businessId)
      .eq('user_id', userId)
      .eq('is_active', true)
      .single();
    
    if (!data || !allowedRoles.includes(data.role as any)) {
      throw new Error('Unauthorized: User is not an admin of this business');
    }
  }
  
  /**
   * Submit business for verification
   */
  async submitForVerification(
    businessId: string,
    userId: string,
    verificationData: VerificationInput
  ): Promise<void> {
    // Verify user is admin
    await this.verifyBusinessAdmin(businessId, userId);
    
    // Check if already verified or pending
    const existing = await this.supabase
      .from('business_verification')
      .select('status')
      .eq('business_id', businessId)
      .maybeSingle();
    
    if (existing.data?.status === 'approved') {
      throw new Error('Business is already verified');
    }
    
    if (existing.data?.status === 'pending') {
      throw new Error('Verification request already pending');
    }
    
    // Create verification request
    const { error } = await this.supabase
      .from('business_verification')
      .insert({
        business_id: businessId,
        verification_method: verificationData.method,
        domain_email: verificationData.email,
        ein_number: verificationData.ein,
        document_urls: verificationData.documentUrls
      });
    
    if (error) throw error;
    
    // If domain email, send verification email
    if (verificationData.method === 'domain_email' && verificationData.email) {
      await this.sendDomainVerificationEmail(businessId, verificationData.email);
    }
    
    // Log action
    await this.logAdminAction(businessId, userId, 'verification_submitted', {
      method: verificationData.method
    });
  }
  
  /**
   * Send domain verification email
   */
  private async sendDomainVerificationEmail(businessId: string, email: string): Promise<void> {
    const token = crypto.randomUUID();
    
    // Store token
    await this.supabase
      .from('business_verification')
      .update({ domain_email_token: token })
      .eq('business_id', businessId);
    
    // TODO: Send email with verification link
    // await emailService.send({
    //   to: email,
    //   subject: 'Verify your business domain',
    //   template: 'domain_verification',
    //   data: { token, businessId }
    // });
  }
  
  /**
   * Verify domain email token
   */
  async verifyDomainEmail(businessId: string, token: string): Promise<void> {
    const { data } = await this.supabase
      .from('business_verification')
      .select('*')
      .eq('business_id', businessId)
      .eq('domain_email_token', token)
      .single();
    
    if (!data) {
      throw new Error('Invalid verification token');
    }
    
    // Mark as verified
    await this.supabase
      .from('business_verification')
      .update({
        status: 'approved',
        domain_email_verified: true,
        last_verified_at: new Date().toISOString()
      })
      .eq('business_id', businessId);
    
    // Update business verification status
    const expiresAt = new Date();
    expiresAt.setFullYear(expiresAt.getFullYear() + 1); // 1 year expiry
    
    await this.supabase
      .from('businesses')
      .update({
        verification_status: 'verified',
        verified_at: new Date().toISOString(),
        verification_expires_at: expiresAt.toISOString()
      })
      .eq('id', businessId);
    
    // Log action
    await this.logAdminAction(businessId, data.business_id, 'business_verified', {
      method: 'domain_email'
    });
  }
  
  /**
   * Get businesses requiring re-verification (within 30 days of expiry)
   */
  async getBusinessesNeedingReverification(): Promise<Business[]> {
    const thirtyDaysFromNow = new Date();
    thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
    
    const { data } = await this.supabase
      .from('businesses')
      .select('*')
      .eq('verification_status', 'verified')
      .lte('verification_expires_at', thirtyDaysFromNow.toISOString())
      .eq('is_active', true);
    
    return data || [];
  }
  
  /**
   * Log admin action for audit trail
   */
  private async logAdminAction(
    businessId: string,
    adminId: string,
    action: string,
    changes?: any
  ): Promise<void> {
    await this.supabase
      .from('business_admin_logs')
      .insert({
        business_id: businessId,
        admin_id: adminId,
        action: action,
        changes: changes || {}
      });
  }
  
  /**
   * Get business by handle
   */
  async getBusinessByHandle(handle: string): Promise<Business | null> {
    const { data } = await this.supabase
      .from('businesses')
      .select(`
        *,
        owner:profiles!owner_id(id, display_name, profile_image_url),
        listings:business_listings(count),
        perks:business_perks(count),
        verification:business_verification(status, verified_at)
      `)
      .eq('handle', handle)
      .eq('is_active', true)
      .single();
    
    return data;
  }
  
  /**
   * Search businesses by filters
   */
  async searchBusinesses(filters: BusinessSearchFilters): Promise<Business[]> {
    let query = this.supabase
      .from('businesses')
      .select('*')
      .eq('is_active', true);
    
    if (filters.serviceTags?.length) {
      query = query.contains('service_tags', filters.serviceTags);
    }
    
    if (filters.location) {
      // Location-based search
      query = query.contains('location', { city: filters.location });
    }
    
    if (filters.verifiedOnly) {
      query = query.eq('verification_status', 'verified');
    }
    
    if (filters.businessPurpose) {
      query = query.eq('business_purpose', filters.businessPurpose);
    }
    
    const { data } = await query.limit(filters.limit || 20);
    
    return data || [];
  }
}

/**
 * BUSINESS LISTING SERVICE
 * =========================
 */
export class BusinessListingService extends BaseDatabaseService {
  
  /**
   * Create a new listing
   */
  async createListing(
    businessId: string,
    userId: string,
    listingData: CreateListingInput
  ): Promise<BusinessListing> {
    // Verify user is admin
    const businessService = new BusinessService(this.supabase);
    await businessService['verifyBusinessAdmin'](businessId, userId);
    
    const { data, error } = await this.supabase
      .from('business_listings')
      .insert({
        business_id: businessId,
        listing_type: listingData.type,
        title: listingData.title,
        description: listingData.description,
        price: listingData.price,
        currency: listingData.currency || 'USD',
        image_url: listingData.imageUrl,
        image_gallery: listingData.imageGallery,
        metadata: listingData.metadata,
        tags: listingData.tags
      })
      .select()
      .single();
    
    if (error) throw error;
    
    // Log action
    await businessService['logAdminAction'](businessId, userId, 'listing_created', {
      listingId: data!.id,
      type: listingData.type
    });
    
    return data!;
  }
  
  /**
   * Get listings by business and type
   */
  async getListingsByBusinessAndType(
    businessId: string,
    listingType?: string
  ): Promise<BusinessListing[]> {
    let query = this.supabase
      .from('business_listings')
      .select('*')
      .eq('business_id', businessId)
      .eq('is_active', true);
    
    if (listingType) {
      query = query.eq('listing_type', listingType);
    }
    
    const { data } = await query.order('created_at', { ascending: false });
    
    return data || [];
  }
}

/**
 * BUSINESS PERK SERVICE (Extended for Featured Perk)
 * ====================================================
 */
export class BusinessPerkService extends BaseDatabaseService {
  
  /**
   * Set a perk as featured (only 1 per business)
   */
  async setFeaturedPerk(
    perkId: string,
    businessId: string,
    userId: string,
    featuredShortText: string
  ): Promise<void> {
    // Verify user is admin
    const businessService = new BusinessService(this.supabase);
    await businessService['verifyBusinessAdmin'](businessId, userId);
    
    // Validate short text length
    if (featuredShortText.length > 50) {
      throw new Error('Featured text must be 50 characters or less');
    }
    
    // Unset any existing featured perk
    await this.supabase
      .from('business_perks')
      .update({ is_featured: false, featured_short_text: null })
      .eq('business_id', businessId)
      .eq('is_featured', true);
    
    // Set new featured perk
    const { error } = await this.supabase
      .from('business_perks')
      .update({
        is_featured: true,
        featured_short_text: featuredShortText
      })
      .eq('id', perkId)
      .eq('business_id', businessId);
    
    if (error) throw error;
    
    // Log action
    await businessService['logAdminAction'](businessId, userId, 'featured_perk_set', {
      perkId,
      featuredText: featuredShortText
    });
  }
  
  /**
   * Get featured perk for a business
   */
  async getFeaturedPerk(businessId: string): Promise<BusinessPerk | null> {
    const { data } = await this.supabase
      .from('business_perks')
      .select('*')
      .eq('business_id', businessId)
      .eq('is_featured', true)
      .eq('is_active', true)
      .maybeSingle();
    
    return data;
  }
}

/**
 * BUSINESS REVIEW SERVICE (NEW from Refresh)
 * ===========================================
 */
export class BusinessReviewService extends BaseDatabaseService {
  
  /**
   * Create a review for a business
   */
  async createReview(
    businessId: string,
    reviewerId: string,
    rating: number,
    reviewText?: string
  ): Promise<BusinessReview> {
    // Validate rating
    if (rating < 1 || rating > 5) {
      throw new Error('Rating must be between 1 and 5');
    }
    
    // Check if user already reviewed this business
    const existing = await this.supabase
      .from('business_reviews')
      .select('id')
      .eq('business_id', businessId)
      .eq('reviewer_id', reviewerId)
      .maybeSingle();
    
    if (existing.data) {
      throw new Error('You have already reviewed this business');
    }
    
    const { data, error } = await this.supabase
      .from('business_reviews')
      .insert({
        business_id: businessId,
        reviewer_id: reviewerId,
        rating: rating,
        review_text: reviewText
      })
      .select()
      .single();
    
    if (error) throw error;
    
    return data!;
  }
  
  /**
   * Update a review
   */
  async updateReview(
    reviewId: string,
    reviewerId: string,
    rating: number,
    reviewText?: string
  ): Promise<BusinessReview> {
    // Validate rating
    if (rating < 1 || rating > 5) {
      throw new Error('Rating must be between 1 and 5');
    }
    
    const { data, error } = await this.supabase
      .from('business_reviews')
      .update({
        rating: rating,
        review_text: reviewText,
        updated_at: new Date().toISOString()
      })
      .eq('id', reviewId)
      .eq('reviewer_id', reviewerId)
      .select()
      .single();
    
    if (error) throw error;
    
    return data!;
  }
  
  /**
   * Hide a review (business admin action, max 3 per business)
   */
  async hideReview(
    reviewId: string,
    businessId: string,
    adminId: string
  ): Promise<void> {
    // Verify user is admin
    const businessService = new BusinessService(this.supabase);
    await businessService['verifyBusinessAdmin'](businessId, adminId);
    
    // Check how many reviews are already hidden
    const { count } = await this.supabase
      .from('business_reviews')
      .select('id', { count: 'exact' })
      .eq('business_id', businessId)
      .eq('is_hidden', true);
    
    if ((count || 0) >= 3) {
      throw new Error('Cannot hide more than 3 reviews per business');
    }
    
    // Hide the review
    const { error } = await this.supabase
      .from('business_reviews')
      .update({
        is_hidden: true,
        hidden_at: new Date().toISOString(),
        hidden_by: adminId
      })
      .eq('id', reviewId)
      .eq('business_id', businessId);
    
    if (error) throw error;
    
    // Log action
    await businessService['logAdminAction'](businessId, adminId, 'review_hidden', {
      reviewId
    });
  }
  
  /**
   * Unhide a review
   */
  async unhideReview(
    reviewId: string,
    businessId: string,
    adminId: string
  ): Promise<void> {
    // Verify user is admin
    const businessService = new BusinessService(this.supabase);
    await businessService['verifyBusinessAdmin'](businessId, adminId);
    
    const { error } = await this.supabase
      .from('business_reviews')
      .update({
        is_hidden: false,
        hidden_at: null,
        hidden_by: null
      })
      .eq('id', reviewId)
      .eq('business_id', businessId);
    
    if (error) throw error;
    
    // Log action
    await businessService['logAdminAction'](businessId, adminId, 'review_unhidden', {
      reviewId
    });
  }
  
  /**
   * Get reviews for a business (excludes hidden reviews for non-admins)
   */
  async getBusinessReviews(
    businessId: string,
    userId?: string
  ): Promise<BusinessReview[]> {
    let query = this.supabase
      .from('business_reviews')
      .select(`
        *,
        reviewer:profiles!reviewer_id(id, display_name, profile_image_url)
      `)
      .eq('business_id', businessId);
    
    // If user is not an admin, exclude hidden reviews
    if (userId) {
      const isAdmin = await this.isBusinessAdmin(businessId, userId);
      if (!isAdmin) {
        query = query.eq('is_hidden', false);
      }
    } else {
      query = query.eq('is_hidden', false);
    }
    
    const { data } = await query.order('created_at', { ascending: false });
    
    return data || [];
  }
  
  /**
   * Get average rating for a business
   */
  async getAverageRating(businessId: string): Promise<{average: number, count: number}> {
    const { data } = await this.supabase
      .from('business_reviews')
      .select('rating')
      .eq('business_id', businessId)
      .eq('is_hidden', false);
    
    if (!data || data.length === 0) {
      return { average: 0, count: 0 };
    }
    
    const sum = data.reduce((acc, review) => acc + review.rating, 0);
    const average = sum / data.length;
    
    return {
      average: Math.round(average * 10) / 10, // Round to 1 decimal
      count: data.length
    };
  }
  
  /**
   * Check if user is business admin
   */
  private async isBusinessAdmin(businessId: string, userId: string): Promise<boolean> {
    const { data } = await this.supabase
      .from('business_admins')
      .select('id')
      .eq('business_id', businessId)
      .eq('user_id', userId)
      .eq('is_active', true)
      .maybeSingle();
    
    return !!data;
  }
}
```

---

## API Contracts

```typescript
/**
 * POST /api/businesses
 * ====================
 * Create a new business profile
 */
interface CreateBusinessRequest {
  // Basic Info
  name: string;
  handle: string; // @businessname (3-30 chars, lowercase, numbers, underscores)
  shortDescription: string; // Max 140 chars
  about: string; // Full description
  
  // What Guides Us
  purpose: 'wellness' | 'coaching' | 'community' | 'lifestyle' | 'healing' | 'product_based' | 'other';
  imageGallery?: string[]; // Up to 6 URLs
  employeeCount?: '1' | '2-10' | '11-50' | '51-200' | '200+';
  size?: 'solo' | 'smb' | 'mid_market' | 'large_enterprise';
  
  // Contact & Social
  email: string;
  phone?: string;
  website?: string;
  socialLinks?: {
    instagram?: string;
    facebook?: string;
    linkedin?: string;
    youtube?: string;
    tiktok?: string;
  };
  contactVisibility?: 'public' | 'private' | 'members_only';
  
  // Location
  location: { city: string; country: string; coordinates?: { lat: number; lng: number } } | 'online';
  marketsServed?: ('local' | 'regional' | 'national' | 'global' | 'online')[];
  
  // What We Offer
  serviceTags: string[]; // From predefined taxonomy
  recommendedPractices?: string[]; // Practice names
  connectionPreferences?: ('messenger' | 'phone' | 'video' | 'appointment' | 'in_person')[];
  
  // How We Flow
  connectionPrompts?: Array<{ question: string; answer?: string }>;
  
  // Media
  logoUrl: string;
}

interface CreateBusinessResponse {
  business: Business;
  profileCompletion: number; // Percentage
  nextSteps: string[]; // Mira suggestions
}

/**
 * PATCH /api/businesses/:id
 * ==========================
 * Update business profile
 */
interface UpdateBusinessRequest {
  // Any field from CreateBusinessRequest (partial update)
  [key: string]: any;
}

interface UpdateBusinessResponse {
  business: Business;
  profileCompletion: number;
  changesSummary: string; // Mira-friendly summary
}

/**
 * GET /api/businesses/:handle
 * ============================
 * Get business by handle
 */
interface GetBusinessResponse {
  business: Business & {
    owner: {
      id: string;
      displayName: string;
      profileImageUrl: string;
    };
    listingsCount: number;
    perksCount: number;
    verification: {
      status: string;
      verifiedAt: string;
    };
  };
  isAdmin: boolean; // True if current user is admin
  alignmentScore?: number; // If user is logged in
}

/**
 * POST /api/businesses/:id/verify
 * ================================
 * Submit business for verification
 */
interface VerifyBusinessRequest {
  method: 'domain_email' | 'ein' | 'document_upload';
  domainEmail?: string; // For domain_email method
  einNumber?: string; // For ein method
  documentUrls?: string[]; // For document_upload method
}

interface VerifyBusinessResponse {
  status: 'pending' | 'approved';
  message: string; // Mira-friendly explanation
  nextSteps?: string[]; // If pending review
}

/**
 * GET /api/businesses/:id/verify/:token
 * ======================================
 * Verify domain email via token
 */
interface VerifyDomainResponse {
  verified: boolean;
  expiresAt: string; // When verification expires (1 year)
  message: string; // Mira celebration
}

/**
 * POST /api/businesses/:id/admins
 * ================================
 * Add admin to business
 */
interface AddAdminRequest {
  userId: string;
  role: 'owner' | 'editor' | 'community_manager';
}

interface AddAdminResponse {
  admin: BusinessAdmin;
  notification: string; // Sent to new admin
}

/**
 * DELETE /api/businesses/:id/admins/:userId
 * ==========================================
 * Remove admin from business
 */
interface RemoveAdminResponse {
  success: boolean;
  message: string;
}

/**
 * GET /api/businesses/:id/admins
 * ===============================
 * Get all admins for business
 */
interface GetAdminsResponse {
  admins: Array<{
    id: string;
    userId: string;
    role: string;
    displayName: string;
    profileImageUrl: string;
    grantedAt: string;
    grantedBy: string;
  }>;
}

/**
 * POST /api/businesses/:id/listings
 * ==================================
 * Create a new listing
 */
interface CreateListingRequest {
  type: 'service' | 'product' | 'event' | 'course' | 'property' | 'job';
  title: string;
  description: string;
  price?: number;
  currency?: string; // Default: USD
  imageUrl?: string;
  imageGallery?: string[];
  metadata: Record<string, any>; // Type-specific fields
  tags?: string[];
}

interface CreateListingResponse {
  listing: BusinessListing;
  message: string; // Mira encouragement
}

/**
 * GET /api/businesses/:id/listings
 * =================================
 * Get listings by business
 */
interface GetListingsRequest {
  type?: 'service' | 'product' | 'event' | 'course' | 'property' | 'job';
  search?: string;
  sortBy?: 'created_at' | 'price' | 'title';
  sortOrder?: 'asc' | 'desc';
}

interface GetListingsResponse {
  listings: BusinessListing[];
  total: number;
  hasMore: boolean;
}

/**
 * GET /api/businesses/search
 * ===========================
 * Search businesses
 */
interface SearchBusinessesRequest {
  query?: string; // Text search
  serviceTags?: string[];
  location?: string; // City name
  verifiedOnly?: boolean;
  businessPurpose?: string;
  limit?: number;
  offset?: number;
}

interface SearchBusinessesResponse {
  businesses: Business[];
  total: number;
  hasMore: boolean;
  miraRecommendations?: Business[]; // Personalized top picks
}

/**
 * GET /api/businesses/:id/profile-completion
 * ===========================================
 * Get profile completion status
 */
interface ProfileCompletionResponse {
  percentage: number;
  completedSections: string[];
  incompleteSections: string[];
  miraSuggestions: Array<{
    section: string;
    prompt: string;
    priority: 'high' | 'medium' | 'low';
  }>;
}

/**
 * POST /api/businesses/:id/perks/:perkId/feature
 * ===============================================
 * Set a perk as featured (only 1 per business)
 */
interface SetFeaturedPerkRequest {
  featuredShortText: string; // Max 50 chars, shows in header
}

interface SetFeaturedPerkResponse {
  perk: BusinessPerk;
  message: string; // Mira celebration
}

/**
 * GET /api/businesses/:id/perks/featured
 * =======================================
 * Get the featured perk for a business
 */
interface GetFeaturedPerkResponse {
  perk: BusinessPerk | null;
}

/**
 * POST /api/businesses/:id/reviews
 * =================================
 * Create a review for a business
 */
interface CreateReviewRequest {
  rating: number; // 1-5
  reviewText?: string;
}

interface CreateReviewResponse {
  review: BusinessReview;
  averageRating: number;
  totalReviews: number;
  message: string; // Mira encouragement
}

/**
 * PATCH /api/businesses/:id/reviews/:reviewId
 * ============================================
 * Update your own review
 */
interface UpdateReviewRequest {
  rating: number; // 1-5
  reviewText?: string;
}

interface UpdateReviewResponse {
  review: BusinessReview;
  message: string;
}

/**
 * POST /api/businesses/:id/reviews/:reviewId/hide
 * ================================================
 * Hide a review (admin only, max 3 per business)
 */
interface HideReviewResponse {
  success: boolean;
  hiddenCount: number; // How many reviews are currently hidden
  message: string; // Warning if approaching limit
}

/**
 * POST /api/businesses/:id/reviews/:reviewId/unhide
 * ==================================================
 * Unhide a previously hidden review
 */
interface UnhideReviewResponse {
  success: boolean;
  hiddenCount: number;
  message: string;
}

/**
 * GET /api/businesses/:id/reviews
 * ================================
 * Get reviews for a business
 */
interface GetReviewsRequest {
  includeHidden?: boolean; // Only works if user is admin
}

interface GetReviewsResponse {
  reviews: Array<BusinessReview & {
    reviewer: {
      id: string;
      displayName: string;
      profileImageUrl: string;
    };
  }>;
  averageRating: number;
  totalReviews: number;
  hiddenCount?: number; // Only returned if user is admin
}
```

---

## Feature Flags

```typescript
export const EPIC_06_FLAGS = {
  // Core Business Features
  'businesses_enabled': { 
    enabled: false, 
    rollout: 0,
    description: 'Master toggle for all business features'
  },
  'business_creation': { 
    enabled: false, 
    rollout: 0,
    description: 'Allow users to create business profiles'
  },
  'business_guided_setup': {
    enabled: false,
    rollout: 0,
    description: 'Mira-guided business profile creation flow'
  },
  'business_profile_framework': {
    enabled: false,
    rollout: 0,
    description: 'Three-part attribute organization (What Guides Us / What We Offer / How We Flow)'
  },
  
  // Verification & Trust
  'business_verification': { 
    enabled: false, 
    rollout: 0,
    description: 'Business verification system (domain, EIN, documents)'
  },
  'domain_email_verification': {
    enabled: false,
    rollout: 0,
    description: 'Instant domain email verification method'
  },
  'ein_verification': {
    enabled: false,
    rollout: 0,
    description: 'EIN-based verification for US businesses'
  },
  'document_verification': {
    enabled: false,
    rollout: 0,
    description: 'Manual document upload verification'
  },
  'verification_badge': {
    enabled: false,
    rollout: 0,
    description: 'Display verification badge on profiles'
  },
  'annual_reverification': {
    enabled: false,
    rollout: 0,
    description: 'Require annual re-verification'
  },
  
  // Listings & Marketplace
  'business_listings': { 
    enabled: false, 
    rollout: 0,
    description: 'Modular listings system (Services, Products, Events, etc.)'
  },
  'listings_services': {
    enabled: false,
    rollout: 0,
    description: 'Service listings'
  },
  'listings_products': {
    enabled: false,
    rollout: 0,
    description: 'Product listings'
  },
  'listings_events': {
    enabled: false,
    rollout: 0,
    description: 'Event listings'
  },
  'listings_courses': {
    enabled: false,
    rollout: 0,
    description: 'Course listings'
  },
  'listings_properties': {
    enabled: false,
    rollout: 0,
    description: 'Property/venue listings'
  },
  'listings_jobs': {
    enabled: false,
    rollout: 0,
    description: 'Job listings'
  },
  'listing_search_filter': {
    enabled: false,
    rollout: 0,
    description: 'Search and filter within listing categories'
  },
  
  // Perks & Value
  'business_perks': { 
    enabled: false, 
    rollout: 0,
    description: 'Member perks system'
  },
  'perk_redemption_tracking': {
    enabled: false,
    rollout: 0,
    description: 'Track perk usage and limits'
  },
  'premium_only_perks': {
    enabled: false,
    rollout: 0,
    description: 'Restrict perks to premium members'
  },
  'featured_perk': {
    enabled: false,
    rollout: 0,
    description: 'Featured perk shown in business header (Refresh feature)'
  },
  
  // Practice Integration
  'practice_stacks': { 
    enabled: false, 
    rollout: 0,
    description: 'Business-recommended practice collections'
  },
  'business_practice_recommendations': {
    enabled: false,
    rollout: 0,
    description: 'Show recommended practices on business profiles'
  },
  
  // Admin & Permissions
  'business_multi_admin': {
    enabled: false,
    rollout: 0,
    description: 'Multiple admins with role-based permissions'
  },
  'business_admin_roles': {
    enabled: false,
    rollout: 0,
    description: 'Owner/Editor/Community Manager role system'
  },
  'business_admin_audit_log': {
    enabled: false,
    rollout: 0,
    description: 'Audit trail for all admin actions'
  },
  'business_mfa_required': {
    enabled: false,
    rollout: 0,
    description: 'Require MFA for business admin accounts'
  },
  
  // Discovery & Search
  'business_discovery': {
    enabled: false,
    rollout: 0,
    description: 'Business profiles in Discovery marketplace'
  },
  'business_search_filters': {
    enabled: false,
    rollout: 0,
    description: 'Advanced search with service tags, location, purpose'
  },
  'business_geo_search': {
    enabled: false,
    rollout: 0,
    description: 'Location-based business search'
  },
  
  // Reviews & Social Proof (NEW from Refresh)
  'business_reviews': {
    enabled: false,
    rollout: 0,
    description: 'Business review system (1 review per user, hide up to 3)'
  },
  'business_ratings': {
    enabled: false,
    rollout: 0,
    description: 'Display average ratings on business profiles'
  },
  
  // Mira Integration
  'mira_business_recommendations': {
    enabled: false,
    rollout: 0,
    description: 'Mira recommends businesses to users'
  },
  'mira_business_onboarding': {
    enabled: false,
    rollout: 0,
    description: 'Mira guides business profile creation'
  },
  'mira_perk_education': {
    enabled: false,
    rollout: 0,
    description: 'Mira explains and promotes member perks'
  },
  'mira_service_explanations': {
    enabled: false,
    rollout: 0,
    description: 'Mira educates users about service types'
  },
  
  // Future/Premium Features
  'business_analytics_dashboard': {
    enabled: false,
    rollout: 0,
    description: 'Business analytics (views, clicks, engagement)'
  },
  'business_booking_integration': {
    enabled: false,
    rollout: 0,
    description: 'Direct booking within platform (future phase)'
  },
  'business_payment_processing': {
    enabled: false,
    rollout: 0,
    description: 'In-platform payments for services (future phase)'
  },
  'business_community_creation': {
    enabled: false,
    rollout: 0,
    description: 'Businesses can create linked communities (Epic 7 integration)'
  }
};
```

---

## UI Components & Flows

### Business Profile Creation Flow (Mira-Guided)

**Step 1: Entry & Welcome**
```typescript
// Entry Point Detection
if (user.onboarding.intention.includes('grow_my_business')) {
  showBusinessCreationPrompt();
}

// Mira Welcome
<MiraMessage>
  "Welcome! Let's create your business profile on VIBEUP. 
   This helps aligned members discover your offerings. 
   I'll guide you through each section—it takes about 10 minutes."
</MiraMessage>

<CTAButton primary>Start Building Your Profile</CTAButton>
<CTAButton secondary>I'll Do This Later</CTAButton>
```

**Step 2: Basic Information (What Guides Us - Part 1)**
```typescript
<FormSection title="Tell us about your business">
  <MiraPrompt>
    "Let's start with the basics. What's your business name?"
  </MiraPrompt>
  
  <TextField 
    label="Business Name"
    required
    maxLength={100}
    placeholder="Sacred Space Yoga Studio"
  />
  
  <TextField 
    label="Choose a Handle"
    required
    prefix="@"
    pattern="[a-z0-9_]{3,30}"
    placeholder="sacredspaceyoga"
    helperText="This creates your unique profile URL: vibeup.io/weare/@sacredspaceyoga"
  />
  
  <ImageUpload
    label="Logo / Profile Image"
    required
    aspectRatio="1:1"
    maxSize="5MB"
  />
  
  <TextArea
    label="Short Description"
    required
    maxLength={140}
    placeholder="A sanctuary for mindful movement and inner peace"
    helperText="This appears in search results and Discovery cards"
    showCharCount
  />
  
  <ProgressIndicator current={1} total={7} />
  <NextButton>Continue</NextButton>
</FormSection>
```

**Step 3: Purpose & Story (What Guides Us - Part 2)**
```typescript
<FormSection title="What guides your work?">
  <MiraPrompt>
    "Tell members about your story and what makes your work unique. 
     This deepens resonance and helps people understand your why."
  </MiraPrompt>
  
  <DropdownSelect
    label="Business Purpose"
    required
    options={[
      'Wellness', 'Coaching', 'Community', 'Lifestyle', 
      'Healing', 'Product-Based', 'Other'
    ]}
  />
  
  <TextArea
    label="About Your Business"
    required
    minLength={100}
    placeholder="Share your story, mission, and what makes you unique..."
    helperText="Aim for 2-3 paragraphs"
  />
  
  <ImageGalleryUpload
    label="Showcase Images"
    maxImages={6}
    helperText="Show your space, team, or offerings (up to 6 images)"
  />
  
  <ProgressIndicator current={2} total={7} />
  <BackButton>Back</BackButton>
  <NextButton>Continue</NextButton>
</FormSection>
```

**Step 4: Location & Scale (What Guides Us - Part 3)**
```typescript
<FormSection title="Where and how do you operate?">
  <MiraPrompt>
    "Help members understand your reach and scale."
  </MiraPrompt>
  
  <LocationPicker
    label="Business Location"
    required
    allowOnlineOnly
    placeholder="San Francisco, CA"
  />
  
  <MultiSelect
    label="Markets Served"
    options={['Local', 'Regional', 'National', 'Global', 'Online']}
  />
  
  <DropdownSelect
    label="Team Size"
    options={['1', '2-10', '11-50', '51-200', '200+']}
  />
  
  <DropdownSelect
    label="Business Size"
    options={['Solo', 'Small Business', 'Mid-Market', 'Large Enterprise']}
  />
  
  <ProgressIndicator current={3} total={7} />
</FormSection>
```

**Step 5: Services & Offerings (What We Offer)**
```typescript
<FormSection title="What do you offer?">
  <MiraPrompt>
    "Select the types of services you provide. This helps us show you 
     to members searching for exactly what you offer."
  </MiraPrompt>
  
  <MultiSelectChips
    label="Service Type Tags"
    required
    searchable
    options={serviceTypeTaxonomy} // Yoga, Therapy, Coaching, Retreats, etc.
    helperText="Select all that apply"
  />
  
  <MultiSelectChips
    label="Recommended Practices"
    searchable
    linkedTo="practice_definitions"
    helperText="Which practices best represent your offerings?"
  />
  
  <MultiSelect
    label="How should people connect with you?"
    options={[
      'Messenger', 'Phone', 'Video Call', 
      'Appointment Booking', 'In-Person'
    ]}
  />
  
  <Accordion title="Add Listings (Optional)">
    <MiraPrompt>
      "You can add Services, Products, Events, Courses, or Jobs now, 
       or come back to this later."
    </MiraPrompt>
    <ListingCreationModule />
  </Accordion>
  
  <ProgressIndicator current={4} total={7} />
</FormSection>
```

**Step 6: Connection & Flow (How We Flow)**
```typescript
<FormSection title="How do you flow?">
  <MiraPrompt>
    "Connection Prompts help spark meaningful conversations with potential clients. 
     Choose questions that invite authentic engagement."
  </MiraPrompt>
  
  <ConnectionPromptSelector
    maxPrompts={3}
    predefinedOptions={[
      "What inspires you most in your work?",
      "How can people support your mission?",
      "What transformation do you help people achieve?",
      "What makes your approach unique?"
    ]}
    allowCustom
  />
  
  <ProgressIndicator current={5} total={7} />
</FormSection>
```

**Step 7: Contact & Social (Visibility)**
```typescript
<FormSection title="How can people reach you?">
  <MiraPrompt>
    "Add your contact info and social links so members can learn more 
     and connect outside VIBEUP."
  </MiraPrompt>
  
  <TextField
    label="Email"
    required
    type="email"
  />
  
  <TextField
    label="Phone"
    type="tel"
  />
  
  <TextField
    label="Website"
    type="url"
  />
  
  <SocialLinksInput
    platforms={['Instagram', 'Facebook', 'LinkedIn', 'YouTube', 'TikTok']}
  />
  
  <RadioGroup
    label="Contact Info Visibility"
    options={[
      { value: 'public', label: 'Public - Anyone can see' },
      { value: 'members_only', label: 'Members Only - Only VIBEUP members' },
      { value: 'private', label: 'Private - Hidden from profile' }
    ]}
    defaultValue="public"
  />
  
  <ProgressIndicator current={6} total={7} />
</FormSection>
```

**Step 8: Review & Verification**
```typescript
<FormSection title="Review your profile">
  <MiraMessage>
    "Looking great! Your profile is {profileCompletion}% complete. 
     Let's review everything before we publish."
  </MiraMessage>
  
  <ProfilePreview business={formData} />
  
  <ProfileCompletionCard
    percentage={profileCompletion}
    completedSections={completedSections}
    incompleteSections={incompleteSections}
  />
  
  <VerificationPrompt>
    <MiraPrompt>
      "Want to verify your business? Verified profiles get higher visibility 
       and build more trust with members."
    </MiraPrompt>
    
    <VerificationMethodSelector
      options={[
        { 
          method: 'domain_email', 
          title: 'Domain Email (Fastest)',
          description: 'Verify via your official business email'
        },
        { 
          method: 'ein', 
          title: 'EIN Number',
          description: 'Enter your Employer Identification Number'
        },
        { 
          method: 'document', 
          title: 'Document Upload',
          description: 'Upload business license or registration'
        }
      ]}
    />
    
    <CTAButton secondary>Skip for Now</CTAButton>
  </VerificationPrompt>
  
  <ProgressIndicator current={7} total={7} />
  <PublishButton primary>Publish My Profile</PublishButton>
</FormSection>
```

**Completion Celebration**
```typescript
<CelebrationScreen>
  <MiraMessage>
    "🎉 Your business profile is live! {businessName} is now part of 
     the VIBEUP conscious commerce ecosystem."
  </MiraMessage>
  
  <StatsCard>
    <Stat label="Profile Completion" value="{percentage}%" />
    <Stat label="Verification Status" value={verificationStatus} />
    <Stat label="Profile Views" value="0" />
  </StatsCard>
  
  <NextStepsCard>
    <h3>Recommended Next Steps:</h3>
    <ul>
      <li>Add your first Service or Event listing</li>
      <li>Create member perks to attract clients</li>
      <li>Join communities aligned with your values</li>
      <li>Share your profile on social media</li>
    </ul>
  </NextStepsCard>
  
  <CTAButton primary href="/weare/{handle}">View My Profile</CTAButton>
  <CTAButton secondary href="/weare/{handle}/listings">Add Listings</CTAButton>
</CelebrationScreen>
```

### Business Profile Page (Public View)

```typescript
<BusinessProfilePage>
  {/* Header Section */}
  <ProfileHeader>
    {/* Featured Perk Badge (NEW from Refresh) */}
    {featuredPerk && (
      <FeaturedPerkBadge position="top-right">
        <PerkIcon icon={Gift} />
        <PerkText>{featuredPerk.featured_short_text}</PerkText>
        <AllPerksLink href="#perks">All Perks</AllPerksLink>
      </FeaturedPerkBadge>
    )}
    
    <LogoImage src={logoUrl} alt={businessName} />
    <TitleSection>
      <BusinessName>{businessName}</BusinessName>
      {verificationStatus === 'verified' && <VerifiedBadge />}
      <Handle>@{handle}</Handle>
      <ShortDescription>{shortDescription}</ShortDescription>
      <Location>{location}</Location>
    </TitleSection>
    
    <MetricsBar>
      <Metric icon={Users} label="Connections" value={connectionsCount} />
      <Metric icon={Posts} label="Posts" value={postsCount} />
      {averageRating > 0 && (
        <Metric icon={Star} label="Rating" value={`${averageRating} (${reviewCount})`} />
      )}
    </MetricsBar>
    
    <ActionBar>
      <CTAButton primary icon={MessageCircle}>Message</CTAButton>
      <CTAButton secondary icon={UserPlus}>Connect</CTAButton>
      <CTAButton secondary icon={Share2}>Share</CTAButton>
      {isOwner && <CTAButton secondary icon={Edit} href="/weare/{handle}/edit">Edit Profile</CTAButton>}
    </ActionBar>
  </ProfileHeader>
  
  {/* Tab Navigation */}
  <TabNavigation horizontal scroll>
    <Tab active>About</Tab>
    {hasListings.services && <Tab>Services</Tab>}
    {hasListings.products && <Tab>Products</Tab>}
    {hasListings.events && <Tab>Events</Tab>}
    {hasListings.courses && <Tab>Courses</Tab>}
    {hasListings.properties && <Tab>Properties</Tab>}
    {hasListings.jobs && <Tab>Jobs</Tab>}
    {hasPerks && <Tab icon={Gift}>Perks</Tab>}
    {hasCommunity && <Tab>Community</Tab>}
  </TabNavigation>
  
  {/* About Tab Content */}
  <TabContent id="about">
    {/* What Guides Us */}
    <Section>
      <SectionTitle>About Us</SectionTitle>
      <ExpandableText maxLines={6}>{about}</ExpandableText>
    </Section>
    
    {imageGallery.length > 0 && (
      <Section>
        <ImageGallery images={imageGallery} />
      </Section>
    )}
    
    {/* What We Offer */}
    <Section>
      <SectionTitle>What We Offer</SectionTitle>
      <ServiceTagGrid tags={serviceTags} />
    </Section>
    
    {recommendedPractices.length > 0 && (
      <Section>
        <SectionTitle>Recommended Practices</SectionTitle>
        <PracticeChips practices={recommendedPractices} />
      </Section>
    )}
    
    {/* How We Flow */}
    {connectionPrompts.length > 0 && (
      <Section>
        <SectionTitle>Connection Prompts</SectionTitle>
        <PromptCards prompts={connectionPrompts} />
      </Section>
    )}
    
    {/* Contact & Social */}
    <Section>
      <SectionTitle>Connect With Us</SectionTitle>
      <ContactGrid>
        {email && <ContactItem icon={Mail} value={email} />}
        {phone && <ContactItem icon={Phone} value={phone} />}
        {website && <ContactItem icon={Globe} value={website} link />}
      </ContactGrid>
      <SocialLinksBar links={socialLinks} />
    </Section>
    
    {/* Business Details */}
    <Section>
      <SectionTitle>Business Details</SectionTitle>
      <DetailGrid>
        <Detail label="Purpose" value={businessPurpose} />
        <Detail label="Team Size" value={employeeCountRange} />
        <Detail label="Markets Served" value={marketsServed.join(', ')} />
        <Detail label="Member Since" value={formatDate(createdAt)} />
      </DetailGrid>
    </Section>
    
    {/* Managed By */}
    <Section>
      <SectionTitle>Managed By</SectionTitle>
      <ProfileCard profile={owner} compact />
    </Section>
    
    {/* Reviews Section (NEW from Refresh) */}
    <Section id="reviews">
      <SectionTitle>
        Reviews ({reviewCount})
        {averageRating > 0 && (
          <RatingDisplay>
            <StarIcon filled />
            <RatingText>{averageRating} average</RatingText>
          </RatingDisplay>
        )}
      </SectionTitle>
      
      {/* Add Review Button (if user hasn't reviewed yet) */}
      {isLoggedIn && !userHasReviewed && (
        <CTAButton primary onClick={openReviewModal}>
          Write a Review
        </CTAButton>
      )}
      
      {/* Reviews List */}
      <ReviewsList>
        {reviews.map(review => (
          <ReviewCard key={review.id}>
            <ReviewHeader>
              <ProfileAvatar 
                src={review.reviewer.profileImageUrl} 
                alt={review.reviewer.displayName}
              />
              <ReviewerInfo>
                <ReviewerName>{review.reviewer.displayName}</ReviewerName>
                <ReviewDate>{formatDate(review.created_at)}</ReviewDate>
              </ReviewerInfo>
              <RatingStars rating={review.rating} />
            </ReviewHeader>
            
            {review.review_text && (
              <ReviewText>{review.review_text}</ReviewText>
            )}
            
            {/* Admin Controls (only visible to business admins) */}
            {isAdmin && (
              <AdminControls>
                {review.is_hidden ? (
                  <CTAButton 
                    small 
                    secondary 
                    onClick={() => unhideReview(review.id)}
                  >
                    Unhide
                  </CTAButton>
                ) : (
                  <CTAButton 
                    small 
                    secondary 
                    onClick={() => hideReview(review.id)}
                    disabled={hiddenReviewCount >= 3}
                  >
                    Hide {hiddenReviewCount >= 3 && '(Max 3)'}
                  </CTAButton>
                )}
              </AdminControls>
            )}
            
            {/* Hidden Badge (only visible to admins) */}
            {review.is_hidden && isAdmin && (
              <HiddenBadge>Hidden from public</HiddenBadge>
            )}
          </ReviewCard>
        ))}
      </ReviewsList>
      
      {reviews.length === 0 && (
        <EmptyState>
          <MiraMessage>
            "Be the first to share your experience with {businessName}! 
             Your review helps others discover aligned services."
          </MiraMessage>
        </EmptyState>
      )}
    </Section>
  </TabContent>
  
  {/* Listings Tabs (Dynamic based on what exists) */}
  <TabContent id="services">
    <ListingGrid type="service" businessId={id} />
  </TabContent>
  
  {/* Perks Tab */}
  {hasPerks && (
    <TabContent id="perks">
      <MiraMessage>
        "As a {membershipTier} member, you have access to exclusive perks 
         from {businessName}."
      </MiraMessage>
      <PerkCardGrid businessId={id} />
    </TabContent>
  )}
  
  {/* Mira Recommendations Sidebar (Conditional) */}
  {isLoggedIn && (
    <MiraSidebar>
      <MiraRecommendationCard>
        <MiraAvatar />
        <RecommendationText>
          "You and {businessName} share {alignmentScore}% alignment. 
           You both value {sharedValues.join(' and ')}."
        </RecommendationText>
      </MiraRecommendationCard>
      
      {relatedBusinesses.length > 0 && (
        <RelatedBusinessesCard>
          <h4>Similar Businesses You Might Like</h4>
          <BusinessCardList businesses={relatedBusinesses} compact />
        </RelatedBusinessesCard>
      )}
    </MiraSidebar>
  )}
</BusinessProfilePage>
```

### Listing Creation Modal

```typescript
<ListingCreationModal type={listingType}>
  <ModalHeader>
    <Title>Create {listingType} Listing</Title>
    <CloseButton />
  </ModalHeader>
  
  <ModalBody>
    <MiraPrompt>
      {listingType === 'service' && 
        "Tell members about this service. Include duration, delivery method, and what they'll experience."}
      {listingType === 'event' && 
        "Share the details of your event. What transformation will attendees experience?"}
      {listingType === 'product' && 
        "Describe your product. What problem does it solve? What makes it special?"}
    </MiraPrompt>
    
    <TextField label="Title" required maxLength={100} />
    <TextArea label="Description" required minLength={50} />
    <PriceInput label="Price" currency="USD" />
    
    <ImageUpload label="Main Image" aspectRatio="16:9" />
    <ImageGalleryUpload label="Additional Images" maxImages={5} />
    
    {/* Type-Specific Fields */}
    {listingType === 'service' && (
      <>
        <TextField label="Duration" placeholder="60 minutes" />
        <DropdownSelect 
          label="Delivery Method" 
          options={['In-Person', 'Online', 'Hybrid']} 
        />
      </>
    )}
    
    {listingType === 'event' && (
      <>
        <DateTimePicker label="Event Date & Time" required />
        <LocationPicker label="Event Location" allowVirtual />
        <NumberInput label="Max Attendees" min={1} />
      </>
    )}
    
    {listingType === 'course' && (
      <>
        <TextField label="Duration" placeholder="6 weeks" />
        <DropdownSelect 
          label="Format" 
          options={['Self-Paced', 'Live Cohort', 'Hybrid']} 
        />
      </>
    )}
    
    {listingType === 'job' && (
      <>
        <DropdownSelect 
          label="Job Type" 
          options={['Full-Time', 'Part-Time', 'Contract', 'Internship']} 
        />
        <LocationPicker label="Location" allowRemote />
      </>
    )}
    
    <TagInput label="Tags" helperText="Add search tags to help people find this" />
  </ModalBody>
  
  <ModalFooter>
    <CTAButton secondary>Cancel</CTAButton>
    <CTAButton primary>Publish Listing</CTAButton>
  </ModalFooter>
</ListingCreationModal>
```

### Review Creation Modal (NEW from Refresh)

```typescript
<ReviewCreationModal businessId={businessId} businessName={businessName}>
  <ModalHeader>
    <Title>Review {businessName}</Title>
    <CloseButton />
  </ModalHeader>
  
  <ModalBody>
    <MiraPrompt>
      "Your honest feedback helps others discover aligned services. 
       Share your experience with {businessName}."
    </MiraPrompt>
    
    <RatingSection>
      <Label>Your Rating *</Label>
      <StarRating 
        value={rating}
        onChange={setRating}
        size="large"
        required
      />
      <HelperText>Tap to rate (1-5 stars)</HelperText>
    </RatingSection>
    
    <TextArea 
      label="Your Review (Optional)"
      placeholder="Share your experience, what you valued most, or how this business supported your journey..."
      rows={6}
      maxLength={500}
      showCharCount
    />
    
    <InfoBox>
      <InfoIcon />
      <InfoText>
        Reviews help build a trusted community. Your review will be visible to all members 
        (unless hidden by business owner - max 3).
      </InfoText>
    </InfoBox>
  </ModalBody>
  
  <ModalFooter>
    <CTAButton secondary>Cancel</CTAButton>
    <CTAButton primary disabled={!rating}>Submit Review</CTAButton>
  </ModalFooter>
</ReviewCreationModal>
```

### Featured Perk Selection (Business Admin)

```typescript
<FeaturedPerkSelectionModal businessId={businessId}>
  <ModalHeader>
    <Title>Set Featured Perk</Title>
    <CloseButton />
  </ModalHeader>
  
  <ModalBody>
    <MiraPrompt>
      "Your Featured Perk appears in two places: the top corner of your profile header 
       and at the bottom of your profile. Choose your most compelling offer!"
    </MiraPrompt>
    
    <PerksList>
      {perks.map(perk => (
        <PerkCard 
          key={perk.id}
          selected={selectedPerk?.id === perk.id}
          onClick={() => setSelectedPerk(perk)}
        >
          <PerkTitle>{perk.perk_title}</PerkTitle>
          <PerkDescription>{perk.perk_description}</PerkDescription>
          <PerkValue badge>{perk.perk_value}</PerkValue>
          
          {perk.is_featured && <FeaturedBadge>Currently Featured</FeaturedBadge>}
        </PerkCard>
      ))}
    </PerksList>
    
    {selectedPerk && (
      <TextField 
        label="Short Text for Header Display"
        value={featuredShortText}
        onChange={setFeaturedShortText}
        maxLength={50}
        placeholder="First Week Free"
        helperText="Max 50 characters - keep it concise and compelling"
        required
        showCharCount
      />
    )}
    
    <InfoBox>
      <InfoIcon />
      <InfoText>
        Only one perk can be featured at a time. The short text appears in your profile 
        header corner, while the full perk details show at the bottom of your About tab.
      </InfoText>
    </InfoBox>
  </ModalBody>
  
  <ModalFooter>
    <CTAButton secondary>Cancel</CTAButton>
    <CTAButton 
      primary 
      disabled={!selectedPerk || !featuredShortText}
    >
      Set as Featured
    </CTAButton>
  </ModalFooter>
</FeaturedPerkSelectionModal>
```

---

## Testing Strategy

### Unit Tests

```typescript
describe('BusinessService', () => {
  describe('createBusiness', () => {
    it('should create business with valid data', async () => {
      const business = await businessService.createBusiness(userId, validData);
      expect(business.id).toBeDefined();
      expect(business.owner_id).toBe(userId);
    });
    
    it('should reject duplicate handle', async () => {
      await businessService.createBusiness(userId, { handle: 'test' });
      await expect(
        businessService.createBusiness(userId2, { handle: 'test' })
      ).rejects.toThrow('Handle already taken');
    });
    
    it('should automatically create owner as admin', async () => {
      const business = await businessService.createBusiness(userId, validData);
      const admins = await businessService.getBusinessAdmins(business.id);
      expect(admins).toHaveLength(1);
      expect(admins[0].role).toBe('owner');
    });
  });
  
  describe('updateProfileCompletion', () => {
    it('should calculate completion percentage correctly', async () => {
      const business = await createMinimalBusiness();
      const completion = await businessService.updateProfileCompletion(business.id);
      expect(completion).toBeGreaterThan(0);
      expect(completion).toBeLessThanOrEqual(100);
    });
    
    it('should give higher weight to required fields', async () => {
      // Test that required fields contribute more to completion percentage
    });
  });
  
  describe('verification', () => {
    it('should submit for domain email verification', async () => {
      await businessService.submitForVerification(businessId, userId, {
        method: 'domain_email',
        email: 'admin@business.com'
      });
      
      // Verify email sent
      expect(emailService.send).toHaveBeenCalled();
    });
    
    it('should verify domain email with valid token', async () => {
      const token = await getVerificationToken(businessId);
      await businessService.verifyDomainEmail(businessId, token);
      
      const business = await businessService.getBusinessById(businessId);
      expect(business.verification_status).toBe('verified');
    });
    
    it('should set expiry date 1 year in future', async () => {
      await verifyBusiness(businessId);
      const business = await businessService.getBusinessById(businessId);
      
      const expiryDate = new Date(business.verification_expires_at);
      const oneYearFromNow = new Date();
      oneYearFromNow.setFullYear(oneYearFromNow.getFullYear() + 1);
      
      expect(expiryDate.getFullYear()).toBe(oneYearFromNow.getFullYear());
    });
  });
  
  describe('admin management', () => {
    it('should allow owner to add editors', async () => {
      await businessService.addBusinessAdmin(businessId, editorId, 'editor', ownerId);
      const admins = await businessService.getBusinessAdmins(businessId);
      expect(admins.find(a => a.user_id === editorId)).toBeDefined();
    });
    
    it('should prevent non-owners from adding admins', async () => {
      await expect(
        businessService.addBusinessAdmin(businessId, newUserId, 'editor', editorId)
      ).rejects.toThrow('Unauthorized');
    });
    
    it('should prevent removing last owner', async () => {
      await expect(
        businessService.removeBusinessAdmin(businessId, ownerId, ownerId)
      ).rejects.toThrow('Cannot remove the last owner');
    });
  });
});

describe('BusinessListingService', () => {
  it('should create listing for business', async () => {
    const listing = await listingService.createListing(businessId, userId, {
      type: 'service',
      title: 'Yoga Class',
      description: 'Vinyasa flow',
      price: 25
    });
    
    expect(listing.listing_type).toBe('service');
    expect(listing.business_id).toBe(businessId);
  });
  
  it('should get listings by type', async () => {
    await createListings(businessId, [
      { type: 'service' },
      { type: 'service' },
      { type: 'event' }
    ]);
    
    const services = await listingService.getListingsByBusinessAndType(
      businessId, 
      'service'
    );
    expect(services).toHaveLength(2);
  });
});

describe('BusinessPerkService (Featured Perk - NEW from Refresh)', () => {
  it('should set a perk as featured', async () => {
    const perk = await createPerk(businessId);
    await perkService.setFeaturedPerk(perk.id, businessId, ownerId, 'First Week Free');
    
    const featured = await perkService.getFeaturedPerk(businessId);
    expect(featured?.id).toBe(perk.id);
    expect(featured?.is_featured).toBe(true);
    expect(featured?.featured_short_text).toBe('First Week Free');
  });
  
  it('should only allow one featured perk per business', async () => {
    const perk1 = await createPerk(businessId);
    const perk2 = await createPerk(businessId);
    
    await perkService.setFeaturedPerk(perk1.id, businessId, ownerId, 'Offer 1');
    await perkService.setFeaturedPerk(perk2.id, businessId, ownerId, 'Offer 2');
    
    const allPerks = await perkService.getBusinessPerks(businessId);
    const featuredCount = allPerks.filter(p => p.is_featured).length;
    
    expect(featuredCount).toBe(1);
    expect(allPerks.find(p => p.id === perk2.id)?.is_featured).toBe(true);
    expect(allPerks.find(p => p.id === perk1.id)?.is_featured).toBe(false);
  });
  
  it('should enforce 50 character limit on featured text', async () => {
    const perk = await createPerk(businessId);
    const longText = 'a'.repeat(51);
    
    await expect(
      perkService.setFeaturedPerk(perk.id, businessId, ownerId, longText)
    ).rejects.toThrow('Featured text must be 50 characters or less');
  });
});

describe('BusinessReviewService (NEW from Refresh)', () => {
  it('should create a review', async () => {
    const review = await reviewService.createReview(businessId, userId, 5, 'Great experience!');
    
    expect(review.business_id).toBe(businessId);
    expect(review.reviewer_id).toBe(userId);
    expect(review.rating).toBe(5);
    expect(review.review_text).toBe('Great experience!');
  });
  
  it('should not allow duplicate reviews', async () => {
    await reviewService.createReview(businessId, userId, 5, 'First review');
    
    await expect(
      reviewService.createReview(businessId, userId, 4, 'Second review')
    ).rejects.toThrow('You have already reviewed this business');
  });
  
  it('should enforce rating between 1-5', async () => {
    await expect(
      reviewService.createReview(businessId, userId, 6)
    ).rejects.toThrow('Rating must be between 1 and 5');
    
    await expect(
      reviewService.createReview(businessId, userId, 0)
    ).rejects.toThrow('Rating must be between 1 and 5');
  });
  
  it('should allow business admin to hide review', async () => {
    const review = await reviewService.createReview(businessId, userId, 3, 'Average');
    await reviewService.hideReview(review.id, businessId, ownerId);
    
    const publicReviews = await reviewService.getBusinessReviews(businessId);
    expect(publicReviews.find(r => r.id === review.id)).toBeUndefined();
    
    // Admin can still see hidden reviews
    const adminReviews = await reviewService.getBusinessReviews(businessId, ownerId);
    const hiddenReview = adminReviews.find(r => r.id === review.id);
    expect(hiddenReview?.is_hidden).toBe(true);
  });
  
  it('should not allow hiding more than 3 reviews', async () => {
    const reviews = await Promise.all([
      reviewService.createReview(businessId, user1Id, 1, 'Bad 1'),
      reviewService.createReview(businessId, user2Id, 1, 'Bad 2'),
      reviewService.createReview(businessId, user3Id, 1, 'Bad 3'),
      reviewService.createReview(businessId, user4Id, 1, 'Bad 4')
    ]);
    
    // Hide first 3
    await reviewService.hideReview(reviews[0].id, businessId, ownerId);
    await reviewService.hideReview(reviews[1].id, businessId, ownerId);
    await reviewService.hideReview(reviews[2].id, businessId, ownerId);
    
    // Try to hide 4th
    await expect(
      reviewService.hideReview(reviews[3].id, businessId, ownerId)
    ).rejects.toThrow('Cannot hide more than 3 reviews per business');
  });
  
  it('should calculate average rating correctly', async () => {
    await reviewService.createReview(businessId, user1Id, 5);
    await reviewService.createReview(businessId, user2Id, 4);
    await reviewService.createReview(businessId, user3Id, 3);
    
    const { average, count } = await reviewService.getAverageRating(businessId);
    expect(average).toBe(4.0);
    expect(count).toBe(3);
  });
  
  it('should exclude hidden reviews from average rating', async () => {
    const review1 = await reviewService.createReview(businessId, user1Id, 5);
    const review2 = await reviewService.createReview(businessId, user2Id, 1);
    
    await reviewService.hideReview(review2.id, businessId, ownerId);
    
    const { average, count } = await reviewService.getAverageRating(businessId);
    expect(average).toBe(5.0);
    expect(count).toBe(1);
  });
  
  it('should allow reviewer to update their own review', async () => {
    const review = await reviewService.createReview(businessId, userId, 3, 'Initial review');
    const updated = await reviewService.updateReview(review.id, userId, 5, 'Updated review');
    
    expect(updated.rating).toBe(5);
    expect(updated.review_text).toBe('Updated review');
  });
});
```

### Integration Tests

```typescript
describe('Business Profile Flow', () => {
  it('should complete full business creation flow', async () => {
    // 1. Create business
    const business = await api.post('/api/businesses', createBusinessData);
    expect(business.id).toBeDefined();
    
    // 2. Submit for verification
    await api.post(`/api/businesses/${business.id}/verify`, {
      method: 'domain_email',
      domainEmail: 'admin@business.com'
    });
    
    // 3. Verify via token
    const token = await getEmailVerificationToken(business.id);
    await api.get(`/api/businesses/${business.id}/verify/${token}`);
    
    // 4. Check business is verified
    const verified = await api.get(`/api/businesses/${business.handle}`);
    expect(verified.business.verification_status).toBe('verified');
    
    // 5. Add listing
    const listing = await api.post(`/api/businesses/${business.id}/listings`, {
      type: 'service',
      title: 'Yoga Class',
      price: 25
    });
    expect(listing.id).toBeDefined();
    
    // 6. Verify listing appears on profile
    const profile = await api.get(`/api/businesses/${business.handle}`);
    expect(profile.business.listingsCount).toBe(1);
  });
});
```

### E2E Tests (Playwright)

```typescript
test('business owner can create and verify profile', async ({ page }) => {
  // Login as business owner
  await loginAsUser(page, businessOwnerEmail);
  
  // Navigate to business creation
  await page.goto('/account/settings');
  await page.click('text=Create Business Profile');
  
  // Mira welcome screen
  await expect(page.locator('text=Welcome! Let\'s create your business')).toBeVisible();
  await page.click('text=Start Building Your Profile');
  
  // Fill basic info
  await page.fill('[name="businessName"]', 'Sacred Space Yoga');
  await page.fill('[name="handle"]', 'sacredspaceyoga');
  await page.setInputFiles('[name="logo"]', 'test-logo.png');
  await page.fill('[name="shortDescription"]', 'A sanctuary for mindful movement');
  await page.click('text=Continue');
  
  // Fill purpose & story
  await page.selectOption('[name="businessPurpose"]', 'wellness');
  await page.fill('[name="about"]', 'We believe in the transformative power of yoga...');
  await page.click('text=Continue');
  
  // ... continue through all steps
  
  // Submit for verification
  await page.click('text=Verify via Domain Email');
  await page.fill('[name="domainEmail"]', 'admin@sacredspaceyoga.com');
  await page.click('text=Send Verification Email');
  
  // Verify success message
  await expect(page.locator('text=Verification email sent')).toBeVisible();
  
  // Publish profile
  await page.click('text=Publish My Profile');
  
  // Verify celebration screen
  await expect(page.locator('text=🎉 Your business profile is live')).toBeVisible();
  
  // View published profile
  await page.click('text=View My Profile');
  await expect(page.locator('text=Sacred Space Yoga')).toBeVisible();
  await expect(page.locator('text=@sacredspaceyoga')).toBeVisible();
});

test('user can discover and connect with business', async ({ page }) => {
  await loginAsUser(page, regularUserEmail);
  
  // Search for yoga businesses
  await page.goto('/discover');
  await page.click('[data-filter="businesses"]');
  await page.fill('[name="search"]', 'yoga');
  await page.click('[data-tag="Yoga"]');
  
  // Click on business profile
  await page.click('text=Sacred Space Yoga');
  
  // View profile details
  await expect(page.locator('h1:has-text("Sacred Space Yoga")')).toBeVisible();
  await expect(page.locator('[data-verification-badge]')).toBeVisible();
  
  // Check Mira alignment explanation
  await expect(page.locator('text=You and Sacred Space Yoga share')).toBeVisible();
  
  // Send connection request
  await page.click('text=Connect');
  
  // Send message
  await page.click('text=Message');
  await page.fill('[name="message"]', 'Hi! I\'m interested in your classes');
  await page.click('text=Send');
  
  // Verify message sent
  await expect(page.locator('text=Message sent')).toBeVisible();
});
```

---

## Mira Integration Points

### Business Discovery & Recommendations

```typescript
/**
 * Mira recommends businesses based on user context
 */
class MiraBusinessRecommendationEngine {
  async recommendBusinesses(userId: string, context: MiraContext): Promise<BusinessRecommendation[]> {
    const userProfile = context.preferences;
    const userIntentions = userProfile.intentions;
    const userValues = userProfile.values;
    const userLocation = context.userState.currentLocation;
    
    // Find businesses aligned with user's profile
    const businesses = await this.searchBusinesses({
      serviceTags: this.mapIntentionsToServices(userIntentions),
      location: userLocation,
      verifiedOnly: true
    });
    
    // Score by alignment
    const scored = businesses.map(business => ({
      business,
      alignmentScore: this.calculateAlignment(userProfile, business),
      reasons: this.explainAlignment(userProfile, business)
    }));
    
    // Sort by score
    scored.sort((a, b) => b.alignmentScore - a.alignmentScore);
    
    return scored.slice(0, 10);
  }
  
  explainAlignment(userProfile: any, business: Business): string[] {
    const reasons = [];
    
    // Shared values
    const sharedValues = userProfile.values.filter(v => 
      business.service_tags.includes(v) || 
      business.about?.includes(v)
    );
    if (sharedValues.length > 0) {
      reasons.push(`You both value ${sharedValues.join(' and ')}`);
    }
    
    // Location proximity
    if (business.location && userProfile.location) {
      const distance = this.calculateDistance(business.location, userProfile.location);
      if (distance < 10) {
        reasons.push(`Only ${distance} miles away`);
      }
    }
    
    // Intention alignment
    if (userProfile.intentions.includes('stress_relief') && 
        business.service_tags.includes('Meditation')) {
      reasons.push('Their meditation services align with your stress relief intention');
    }
    
    // Social proof
    const mutualConnections = this.getMutualConnections(userProfile.id, business.id);
    if (mutualConnections.length > 0) {
      reasons.push(`${mutualConnections.length} of your connections follow this business`);
    }
    
    return reasons;
  }
  
  generateRecommendationPrompt(business: Business, reasons: string[]): string {
    return `Based on your profile, I think ${business.business_name} might resonate with you. ${reasons.join('. ')}.`;
  }
}
```

### Business Onboarding Assistance

```typescript
/**
 * Mira guides business owners through profile creation
 */
class MiraBusinessOnboardingAssistant {
  generatePromptForSection(section: string, context: any): string {
    const prompts = {
      basic_info: "Let's start with the basics. What's your business name? This is how members will find you on VIBEUP.",
      
      purpose_story: "Tell me about your story. What inspired you to start this business? What transformation do you help people achieve?",
      
      services: "What services do you offer? Be specific—this helps me connect you with members seeking exactly what you provide.",
      
      perks: "Would you like to offer perks for VIBEUP members? This could be a discount, free trial, or exclusive access. Perks help attract your ideal clients.",
      
      verification: "Verifying your business builds trust and increases visibility. I can help you through the fastest method: domain email verification.",
      
      completion: `Your profile is ${context.completionPercent}% complete! ${context.completionPercent >= 60 ? 'Great work!' : 'Let\'s keep going to unlock full visibility.'}`
    };
    
    return prompts[section] || '';
  }
  
  suggestNextSteps(business: Business, completionData: any): string[] {
    const suggestions = [];
    
    if (!business.logo_url) {
      suggestions.push('Add a professional logo to make your profile stand out');
    }
    
    if (!business.image_gallery || business.image_gallery.length === 0) {
      suggestions.push('Upload photos of your space or team to build trust');
    }
    
    if (business.verification_status === 'unverified') {
      suggestions.push('Verify your business to increase visibility by 3x');
    }
    
    if (completionData.listingsCount === 0) {
      suggestions.push('Add your first service listing to start attracting clients');
    }
    
    if (!business.connection_prompts || business.connection_prompts.length === 0) {
      suggestions.push('Add Connection Prompts to make it easy for members to start conversations');
    }
    
    return suggestions;
  }
}
```

---

## Related Documentation

**Epic Documents**:
- [`epic-00-foundation.md`](epic-00-foundation.md) - Infrastructure and database setup
- [`epic-01-mira.md`](epic-01-mira.md) - Mira AI platform concierge
- [`epic-02-humans.md`](epic-02-humans.md) - Human profiles and chemistry
- [`epic-04-discovery.md`](epic-04-discovery.md) - Discovery marketplace integration
- [`epic-07-community.md`](epic-07-community.md) - Business-led communities
- [`epic-08-monetization.md`](epic-08-monetization.md) - Business perks and premium features

**Technical References**:
- [`data-models.md`](../architecture/data-models.md) - Complete database schema
- [`api-reference.md`](../architecture/api-reference.md) - All API endpoints
- [`ai-model-router.md`](../architecture/ai-model-router.md) - Mira's multi-model intelligence
- [`testing-strategy.md`](../operations/testing-strategy.md) - TDD framework

**Master Plan**:
- [`MASTER-PLAN.md`](../MASTER-PLAN.md) - Platform vision and architecture

---

**Version**: 2.0.0 (Updated with Notion Epic 6 comprehensive details)  
**Last Updated**: December 16, 2025  
**Status**: Complete specification - ready for implementation

---

## Conscious Development Approach

**Divine Guide**: **Gaia** (Earth Mother) leads Epic 06 development—sustainable infrastructure for conscious commerce and service provider ecosystem.

### Gaia's Guidance for Business Infrastructure

Epic 06 is about conscious commerce—businesses and services integrated into consciousness platform. This requires rock-solid infrastructure: payment processing, booking systems, review platforms all must be utterly reliable. Trust is sacred.

**Development Practices**:

1. **Foundation for Commerce**:
   - Payment processing infrastructure bulletproof (Stripe integration resilient)
   - Booking system handles conflicts gracefully (timezone aware, double-booking prevented)
   - Review system protected from manipulation (verified purchases only)
   - Perk delivery reliable (Regenerative member benefits always work)
   - Performance optimized (business listings fast, search responsive)

2. **Conscious Commit Examples**:
   ```
   🌍 Implement resilient Stripe webhook reconciliation
   
   Intention: Ensure payment events never lost even during network
   issues, protecting both users and service providers in sacred
   value exchange.
   
   Mantra: Commerce deserves stability.
   
   Dedication: To Gaia's earth wisdom of reliable infrastructure.
   
   Gratitude: To deployment ritual practice enabling confident release.
   ```

3. **Infrastructure Meditation**:
   - Monitor payment flows constantly (money is trust manifest)
   - Cache business listings intelligently (fast discovery)
   - Scale booking system organically (growth without breaking)
   - Log all commerce events (audit trail for troubleshooting)
   - Alert on anomalies immediately (earth sensing disturbance)

4. **Earth Wisdom in Code**:
   ```typescript
   // Payment processing as sacred exchange
   async function processBooking(booking: BookingRequest): Promise<Booking> {
     // 1. Validate thoroughly (protect both parties)
     await validateBooking(booking);
     
     // 2. Check availability (prevent double-booking)
     const available = await checkTimeSlotAvailable(booking);
     if (!available) {
       throw new ConflictError('Time slot no longer available');
     }
     
     // 3. Process payment (money exchange is sacred)
     const payment = await stripe.processPayment({
       amount: booking.price,
       userId: booking.userId,
       businessId: booking.businessId,
       metadata: { bookingId: booking.id }
     });
     
     // 4. Create booking (commit to relationship)
     const created = await db.bookings.insert(booking);
     
     // 5. Notify both parties (communication is care)
     await notifyUser(booking.userId, 'Booking confirmed');
     await notifyBusiness(booking.businessId, 'New booking');
     
     // 6. Audit log (transparency builds trust)
     await auditLog.record('booking.created', booking);
     
     return created;
   }
   ```

**Gaia's Standards for Commerce**:
- Payment bugs are unacceptable (money is trust)
- Booking conflicts prevented (disappointing users breaks trust)
- Reviews authentic (manipulation destroys value)
- Perk delivery reliable (promises must be kept)
- Performance fast (slow commerce frustrates)

**Infrastructure Resilience**:
- Stripe webhooks: Primary + reconciliation backup
- Booking conflicts: Database constraints + application logic
- Review spam: Rate limiting + verification checks
- Image delivery: CDN + lazy loading + optimization
- Search performance: Elasticsearch + caching + pagination

**Invocation**:
```bash
/personality-change gaia

# Gaia ensures commerce infrastructure stable
> How should I handle Stripe webhook failures gracefully?
> Optimize business listing performance with earth wisdom
> Deploy payment processing with confidence
```

